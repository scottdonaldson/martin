Martin.extend({setOriginalData:function(){this.layers[this.currentLayer].originalData=this.context.getImageData(0,0,this.width(),this.height())},gradient:function(t){var a=t.angle?t.angle+90:90,h=Martin.degToRad(a),n=t.start?t.start:0,i=t.end?t.end:100,s=Math.tan(h);if(n>=i)throw new Error("End must be greater than start.");n/=100,i/=100,Math.abs(s)>1e4&&(s=!1);var r,e={x:n*this.canvas.width+.5*(i-n)*this.canvas.width,y:Math.floor(this.canvas.height/2)},c=Math.round(-s*e.x+e.y),o=function(t,a){var h,n;return 0===s?n=Math.abs(e.y-a):s?(h=(t+s*a-s*c)/(s*s+1),n=(h-t)*(h-t)+(s*h+c-a)*(s*h+c-a),n=Math.sqrt(n)):n=Math.abs(e.x-t),x(t,a).x<0&&(n*=-1),n},x=function(t,a){t-=e.x,a-=e.y;var n={x:a,y:-t},i=Math.cos(-h),s=Math.sin(-h),r={x:n.x*i-n.y*s,y:n.x*i+n.y*s};return r},d=0,y=1,v=[{x:n*this.canvas.width,y:0},{x:n*this.canvas.width,y:this.canvas.height},{x:i*this.canvas.width,y:0},{x:i*this.canvas.width,y:this.canvas.height}];return v.forEach(function(t){var a=o(t.x,t.y);a>d&&(d=a)}),y=255/d,this.loop(function(t,a,h){return r=o(t,a),h.a=.5*(r+d)*y,h},!0,!0),this}});