window.Martin=function(a,b){if(!(this instanceof Martin))return new Martin(a,b);if(this.original=document.getElementById(a),!this.original||!a)throw new Error("Must provide a <canvas> or <img> element.");var c=this.handleLoad;this.makeCanvas(c.bind(this),b)},Martin._version="0.1.3-beta",Martin.prototype.makeCanvas=function(a,b){if("IMG"===this.original.tagName){var c=this,d=function(){var d=document.createElement("canvas");return d.width=c.original.naturalWidth,d.height=c.original.naturalHeight,d.getContext("2d").drawImage(c.original,0,0),c.original.parentNode.insertBefore(d,c.original),c.original.parentNode.removeChild(c.original),c.canvas=d,c.context=d.getContext("2d"),a(b)};if(this.original.complete)return d();this.original.onload=d}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),a(b)},Martin.prototype.handleLoad=function(a){var b=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),b.insertBefore(this.container,this.canvas),this.container.appendChild(this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var c=document.createElement("style");return c.innerHTML="[data-martin] *{position:absolute;bottom:0;left:0;}",document.head.appendChild(c),this.layers=[{canvas:this.canvas,context:this.context}],this.currentLayer=0,a(this)},Martin.degToRad=function(a){return a*(Math.PI/180)},Martin.radToDeg=function(a){return a*(180/Math.PI)},Martin.hexToRGB=function(a){if(!a)return!1;"#"===a.slice(0,1)&&(a=a.slice(1));var b,c,d;return 6===a.length?(b=a.slice(0,2),c=a.slice(2,4),d=a.slice(4,6)):3===a.length&&(b=a.slice(0,1)+a.slice(0,1),c=a.slice(1,2)+a.slice(1,2),d=a.slice(2,3)+a.slice(2,3)),{r:parseInt(b,16),g:parseInt(c,16),b:parseInt(d,16)}},Martin.extend=function(a){for(var b in a)Martin.prototype[b]=a[b]},Martin.prototype.convertToImage=function(a){if(a)return this.mergeLayers(a);this.mergeLayers();var b=document.createElement("img");b.src=this.layers[0].canvas.toDataURL(),this.container.removeChild(this.layers[0].canvas),this.container.appendChild(b)},Martin.prototype.normalizeX=function(a){return"string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentX(+a.slice(0,-1)):a},Martin.prototype.normalizeY=function(a){return a="string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentY(+a.slice(0,-1)):a,this.canvas.height-a},Martin.prototype.normalizePercentX=function(a){return a/100*this.canvas.width},Martin.prototype.normalizePercentY=function(a){return a/100*this.canvas.height},Martin.prototype.setContext=function(a){var b=this.context;b.save(),b.fillStyle=a.color||"#000",b.fill(),b.globalAlpha=a.alpha||1,b.lineWidth=a.strokeWidth?a.strokeWidth:0,b.lineCap=a.cap?a.cap:"square",b.strokeStyle=a.stroke?a.stroke:"transparent",b.stroke(),b.restore()},Martin.prototype.loop=function(a,b){for(var c,d,e,f,g,h,i,j,k,l=this.context.getImageData(0,0,this.width(),this.height()),m=l.data,n=m.length,o=0;n>o;o+=4)c=o/4,d=c%this.width(),e=this.height()-Math.floor(c/this.width()),f=m[o],g=m[o+1],h=m[o+2],i=m[o+3],j={r:f,g:g,b:h,a:i},k=a.call(this,d,e,j),m[o]=k.r,m[o+1]=k.g,m[o+2]=k.b,m[o+3]=k.a;return b!==!1&&this.context.putImageData(l,0,0),this},Martin.prototype.putImageData=function(a){return this.context.putImageData(a,0,0),this},Martin.prototype.newLayer=function(a,b){var c=document.createElement("canvas"),d={};if(c.width=this.canvas.width,c.height=this.canvas.height,this.container.appendChild(c),this.context=c.getContext("2d"),this.currentLayer=this.layers.length,b&&this.context.putImageData(b,0,0),d.canvas=c,d.context=this.context,"string"==typeof a)d.type=a;else for(var e in a)d[e]=a[e];return this.layers.push(d),this},Martin.prototype.duplicateLayer=function(){return this.newLayer("",this.context.imageData),this},Martin.prototype.deleteLayer=function(a){if(!(this.layers.length>1))throw new Error("Can't delete the only layer.");return a=a||this.currentLayer,this.container.removeChild(this.layers[a].canvas),this.layers.splice(a,1),this},Martin.prototype.clearLayer=function(a){var b=this.currentLayer;a&&this.switchToLayer(a),this.context.clearRect(0,0,this.width(),this.height()),this.switchToLayer(b)},Martin.prototype.switchToLayer=function(a){return this.context=this.layers[a||0].context,this.currentLayer=a||0,this},Martin.prototype.mergeLayers=function(a){function b(a){return a>0?(d=g[a-1],e=d.context,c=g[a],f=g[a].canvas,e.drawImage(f,0,0),this.container.removeChild(g[a].canvas),g.pop(),b.call(this,a-1)):void 0}var c,d,e,f,g=this.layers;if(a){var h=0;for(d=document.createElement("canvas"),e=d.getContext("2d"),d.setAttribute("width",this.width()),d.setAttribute("height",this.height());h<g.length;)e.drawImage(g[h].canvas,0,0),h++}else b.call(this,g.length-1);return a?d.toDataURL():this},Martin.prototype.line=function(a){return this.context.beginPath(),this.context.moveTo(this.normalizeX(a.startX),this.normalizeY(a.startY)),this.context.lineTo(this.normalizeX(a.endX),this.normalizeY(a.endY)),a.strokeWidth||(a.strokeWidth=1),a.stroke=a.color?a.color:"#000",this.setContext(a),this},Martin.prototype.rect=function(a){return a.offsetX||(a.offsetX=0),a.offsetY||(a.offsetY=0),this.context.beginPath(),this.context.rect(this.normalizeX(a.offsetX),this.normalizeY(a.offsetY),this.normalizeX(a.width),-this.canvas.height+this.normalizeY(a.height)),this.setContext(a),this.context.closePath(),this},Martin.prototype.circle=function(a){a.offsetX||(a.offsetX=this.width()/2),a.offsetY||(a.offsetY=this.height()/2);var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);return this.context.beginPath(),this.context.arc(b,c,a.radius,0,2*Math.PI,!1),this.setContext(a),this},Martin.prototype.ellipse=function(a){if(a.offsetX||(a.offsetX=this.width()/2),a.offsetY||(a.offsetY=this.height()/2),a.radiusX===a.radiusY)return a.radius=a.radiusX,this.circle(a);var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);this.context.beginPath();var d;return a.radiusX>a.radiusY?(d=a.radiusX/a.radiusY,this.context.scale(d,1),this.context.arc(b/d,c,a.radiusX/d,0,2*Math.PI,!1)):(d=a.radiusY/a.radiusX,this.context.scale(1,d),this.context.arc(b,c/d,a.radiusY/d,0,2*Math.PI,!1)),this.setContext(a),this.context.restore(),this},Martin.prototype.polygon=function(a,b){"string"==typeof b&&(b={color:b}),this.context.beginPath();for(var c=0;c<a.length;c++){var d=this.normalizeX(a[c][0]),e=this.normalizeY(a[c][1]);0===c&&this.context.moveTo(d,e),this.context.lineTo(d,e)}return this.context.lineTo(this.normalizeX(a[0][0]),this.normalizeY(a[0][1])),this.setContext(b),this.context.closePath(),this},Martin.prototype.desaturate=function(a,b){function c(b){d.switchToLayer(b),d.loop(function(b,c,d){var e=d.r,f=d.g,g=d.b,h=.3*e+.59*f+.11*g;return e=(1-a)*e+a*h,f=(1-a)*f+a*h,g=(1-a)*g+a*h,d.r=e,d.g=f,d.b=g,d})}var d=this;return a/=100,a>1&&(a=1),b?this.layers.forEach(function(a,b){c(b)}):c(this.currentLayer),this},Martin.prototype.saturate=function(a,b){return this.desaturate(-a,b)},Martin.prototype.lighten=function(a,b){function c(b){d.switchToLayer(b),d.loop(function(b,c,d){return d.r+=Math.round(255*a/100),d.g+=Math.round(255*a/100),d.b+=Math.round(255*a/100),d})}var d=this;return b?this.layers.forEach(function(a,b){c(b)}):c(this.currentLayer),this},Martin.prototype.darken=function(a){return this.lighten(-a),this},Martin.prototype.opacity=function(a,b){function c(b){d.switchToLayer(b),d.loop(function(b,c,d){return d.a*=a,d})}var d=this;return b?this.layers.forEach(function(a,b){c(b)}):c(this.currentLayer),this},Martin.mul_shift_table=function(a){var b=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],c=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[b[a],c[a]]},Martin.BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},Martin.prototype.blur=function(a,b){function c(b,c){d.switchToLayer(c);var n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=e,F=d.context.getImageData(0,0,f,g),G=F.data,H=new Martin.BlurStack,I=H;for(p=1;k>p;p++)I=I.next=new Martin.BlurStack,p===j&&(C=I);for(I.next=H,D=null;E-->0;){for(t=s=0,o=g;--o>-1;){for(u=j*(y=G[s]),v=j*(z=G[s+1]),w=j*(A=G[s+2]),x=j*(B=G[s+3]),I=H,p=j;--p>-1;)I.r=y,I.g=z,I.b=A,I.a=B,I=I.next;for(p=1;j>p;p++)q=s+((p>h?h:p)<<2),u+=I.r=G[q],v+=I.g=G[q+1],w+=I.b=G[q+2],x+=I.a=G[q+3],I=I.next;for(D=H,n=0;f>n;n++)G[s++]=u*l>>>m,G[s++]=v*l>>>m,G[s++]=w*l>>>m,G[s++]=x*l>>>m,q=t+((q=n+a+1)<h?q:h)<<2,u-=D.r-(D.r=G[q]),v-=D.g-(D.g=G[q+1]),w-=D.b-(D.b=G[q+2]),x-=D.a-(D.a=G[q+3]),D=D.next;t+=f}for(n=0;f>n;n++){for(s=n<<2,u=j*(y=G[s]),v=j*(z=G[s+1]),w=j*(A=G[s+2]),x=j*(B=G[s+3]),I=H,p=0;j>p;p++)I.r=y,I.g=z,I.b=A,I.a=B,I=I.next;for(r=f,p=1;a>=p;p++)s=r+n<<2,u+=I.r=G[s],v+=I.g=G[s+1],w+=I.b=G[s+2],x+=I.a=G[s+3],I=I.next,i>p&&(r+=f);for(s=n,D=H,o=0;g>o;o++)q=s<<2,G[q+3]=B=x*l>>>m,B>0?(B=255/B,G[q]=(u*l>>>m)*B,G[q+1]=(v*l>>>m)*B,G[q+2]=(w*l>>>m)*B):G[q]=G[q+1]=G[q+2]=0,q=n+((q=o+j)<i?q:i)*f<<2,u-=D.r-(D.r=G[q]),v-=D.g-(D.g=G[q+1]),w-=D.b-(D.b=G[q+2]),x-=D.a-(D.a=G[q+3]),D=D.next,s+=f}}d.putImageData(F)}if(isNaN(a)||1>a)return this;var d=this,e=2,f=this.width(),g=this.height(),h=f-1,i=g-1,j=a+1,k=2*a+1,l=Martin.mul_shift_table(a)[0],m=Martin.mul_shift_table(a)[1];return b?this.layers.forEach(c):c(null,this.currentLayer),this},["width","height"].forEach(function(a){Martin.prototype[a]=function(b,c){if(!b)return this.canvas[a];var d,e,f,g,h;"string"==typeof b&&"%"===b.slice(-1)&&(b=+b.slice(0,-1)*this.canvas[a]/100),e=this.canvas.height,this.container.style[a]=b+"px",f=b/this.canvas[a];for(var i=this.layers.length-1;i>=0;i--)d=this.layers[i].context.getImageData(0,"height"!==a||c?0:this.canvas.height-b,this.canvas.width,this.canvas.height),g=document.createElement("canvas"),h=g.getContext("2d"),g.setAttribute("width",this.canvas.width),g.setAttribute("height",this.canvas.height),h.putImageData(this.layers[i].context.getImageData(0,0,this.canvas.width,this.canvas.height),0,0),this.layers[i].canvas.setAttribute(a,b),c&&this.layers[i].context.scale("width"===a?f:1,"height"===a?f:1),this.layers[i].context.drawImage(g,0,"height"!==a||c?0:b-e);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.write=function(a,b){var c,d;"string"==typeof a?(c=a,d=b):(d=a,c=d.text||""),d||(d={});var e=d.size||16,f=e+"px ";return f+=d.font?'"'+d.font+'"':"sans-serif",this.context.font=f,this.context.fillStyle=d.color||"#000",this.context.textBaseline="top",this.context.textAlign=d.align||"left",this.context.fillText(c,this.normalizeX(d.offsetX||0),d.offsetY?this.normalizeY(d.offsetY)-e:this.canvas.height-e),this},Martin.prototype.background=function(a){var b=this.currentLayer,c=0;if("background"!==this.layers[0].type){c=1,this.newLayer({type:"background",fill:a});for(var d=this.layers.pop(),e=this.container.firstChild,f=this.layers.length;f>=0;f--)this.layers[f]=this.layers[f-1]||d;this.switchToLayer(0),this.container.insertBefore(d.canvas,e)}else this.layers[0].fill=a,this.switchToLayer(0);for(var g=Martin.hexToRGB(a),h=g.r,i=g.g,j=g.b,k=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),l=k.data,m=l.length,n=0;m>n;n+=4)l[n]=h,l[n+1]=i,l[n+2]=j,l[n+3]=255;return this.putImageData(k),this.switchToLayer(b+c),this};