window.Martin=function(t,e){if(!(this instanceof Martin))return new Martin(t,e);if(this.original=document.getElementById(t),!this.original||!t)throw new Error("Must provide a <canvas> or <img> element.");var i=this.handleLoad;this.makeCanvas(i.bind(this),e)},Martin._version="0.1.3.1-beta",Martin.prototype.makeCanvas=function(t,e){if("IMG"===this.original.tagName){var i=this,n=function(){var n=document.createElement("canvas");return n.width=i.original.naturalWidth,n.height=i.original.naturalHeight,n.getContext("2d").drawImage(i.original,0,0),i.original.parentNode.insertBefore(n,i.original),i.original.parentNode.removeChild(i.original),i.canvas=n,i.context=n.getContext("2d"),t(e)};if(this.original.complete)return n();this.original.onload=n}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),t(e)},Martin.prototype.handleLoad=function(t){var e=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),e.insertBefore(this.container,this.canvas),this.canvas.parentNode.removeChild(this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var i=document.createElement("style");return i.innerHTML="[data-martin] *{position:absolute;top:0;left:0;}",document.head.appendChild(i),this.newLayer(this.canvas),t(this)},Martin.degToRad=function(t){return t*(Math.PI/180)},Martin.radToDeg=function(t){return t*(180/Math.PI)},Martin.hexToRGB=function(t){if(!t)return!1;"#"===t.slice(0,1)&&(t=t.slice(1));var e,i,n;return 6===t.length?(e=t.slice(0,2),i=t.slice(2,4),n=t.slice(4,6)):3===t.length&&(e=t.slice(0,1)+t.slice(0,1),i=t.slice(1,2)+t.slice(1,2),n=t.slice(2,3)+t.slice(2,3)),{r:parseInt(e,16),g:parseInt(i,16),b:parseInt(n,16)}},Martin.extend=function(t){for(var e in t)Martin.prototype[e]=t[e]},Martin.prototype.convertToImage=function(){var t=this.toDataURL(),e=document.createElement("img");e.src=t,this.layers.forEach(function(t,e){this.deleteLayer(e)},this),this.container.appendChild(e)},Martin.prototype.normalizeX=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentX(+t.slice(0,-1)):t},Martin.prototype.normalizeY=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentY(+t.slice(0,-1)):t},Martin.prototype.normalizePercentX=function(t){return t/100*this.canvas.width},Martin.prototype.normalizePercentY=function(t){return t/100*this.canvas.height},Martin.setContext=function(t,e){t.save(),t.fillStyle=e.color||"#000",t.fill(),t.globalAlpha=e.alpha||1,t.lineWidth=e.strokeWidth?e.strokeWidth:0,t.lineCap=e.cap?e.cap:"square",t.strokeStyle=e.stroke?e.stroke:"transparent",t.stroke(),t.restore()},Martin.prototype.loop=function(t,e){for(var i,n,r,a,s,o,h,c,l,u=this.context.getImageData(0,0,this.width(),this.height()),f=u.data,p=f.length,d=0;p>d;d+=4)i=d/4,n=i%this.width(),r=this.height()-Math.floor(i/this.width()),a=f[d],s=f[d+1],o=f[d+2],h=f[d+3],c={r:a,g:s,b:o,a:h},l=t.call(this,n,r,c),f[d]=l.r,f[d+1]=l.g,f[d+2]=l.b,f[d+3]=l.a;return e!==!1&&this.context.putImageData(u,0,0),this},Martin.prototype.putImageData=function(t){return this.context.putImageData(t,0,0),this},Martin.Layer=function(t,e){if(this.DOMelement=document.createElement("div"),this.DOMelement.setAttribute("data-martin",""),this.DOMelement.setAttribute("data-martin-layer",""),this.width=t.width,this.height=t.height,this.elements=[],"string"==typeof e)this.type=e;else for(var i in e)this[i]=e[i];return this},Martin.Layer.prototype.addElement=function(t){var e=document.createElement("canvas");return e.width=this.width,e.height=this.height,this.DOMelement.appendChild(e),this.canvas=e,this.context=e.getContext("2d"),this.elements.push({type:t}),this.elements.length-1},Martin.prototype.newLayer=function(t,e){var i=new Martin.Layer(this.canvas);return this.layers||(this.layers=[],i.DOMelement.appendChild(this.canvas)),this.container.insertBefore(i.DOMelement,this.firstChild),this.context=i.context,this.currentLayerIndex=this.layers.length,this.currentLayer=i,this.layers.push(i),this},Martin.prototype.duplicateLayer=function(){return this.newLayer("",this.context.imageData),this},Martin.prototype.deleteLayer=function(t){return t=t||this.currentLayerIndex,this.container.removeChild(this.layers[t].DOMelement),this.layers.splice(t,1),this},Martin.prototype.clearLayer=function(t){var e=this.currentLayerIndex;t&&this.switchToLayer(t),this.context.clearRect(0,0,this.width(),this.height()),this.switchToLayer(e)},Martin.prototype.switchToLayer=function(t){return this.context=this.layers[t||0].context,this.currentLayer=this.layers[t||0],this.currentLayerIndex=t||0,this},Martin.prototype.toDataURL=function(){var t=this.layers,e=document.createElement("canvas"),i=e.getContext("2d");return e.width=this.width(),e.height=this.height(),t.forEach(function(t,e){t.DOMelement.children&&Array.prototype.slice.call(t.DOMelement.children).forEach(function(t){i.drawImage(t,0,0)})}),e.toDataURL()},Martin.Element=function(t,e,i){if(Martin.Element.prototype.hasOwnProperty(t)){var n=e.currentLayer,r=n.addElement(t);return this.base=e,this.layer=n,this.canvas=this.layer.canvas,this.context=this.layer.context,this.data=i,this.type=t,this.index=r,this[t].call(n,e,i),this}throw new Error("Given type is not an allowed element. Check Martin.elements for allowed types.")},Martin.Element.prototype.line=function(t,e){return this.context.beginPath(),this.context.moveTo(t.normalizeX(e.startX||0),t.normalizeY(e.startY||0)),this.context.lineTo(t.normalizeX(e.endX||t.width()),t.normalizeY(e.endY||t.height())),e.strokeWidth||(e.strokeWidth=1),e.stroke=e.color?e.color:"#000",Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.rect=function(t,e){return this.context.beginPath(),this.context.rect(t.normalizeX(e.offsetX||0),t.normalizeY(e.offsetY||0),t.normalizeX(e.width),t.normalizeY(e.height)),Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.circle=function(t,e){var i=t.normalizeX(e.offsetX||0),n=t.normalizeY(e.offsetY||0);return this.context.beginPath(),this.context.arc(i,n,e.radius,0,2*Math.PI,!1),Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.ellipse=function(t,e){if(e.radiusX===e.radiusY)return e.radius=e.radiusX,this.circle(t,e);var i,n=t.normalizeX(e.offsetX||0),r=t.normalizeY(e.offsetY||0);return this.context.beginPath(),e.radiusX>e.radiusY?(i=e.radiusX/e.radiusY,this.context.scale(i,1),this.context.arc(n/i,r,e.radiusX/i,0,2*Math.PI,!1),this.context.scale(1/i,1)):(i=e.radiusY/e.radiusX,this.context.scale(1,i),this.context.arc(n,r/i,e.radiusY/i,0,2*Math.PI,!1),this.context.scale(1,1/i)),Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.polygon=function(t,e){this.context.beginPath();for(var i=0;i<e.points.length;i++){var n=e.points[i][0],r=e.points[i][1],a=t.normalizeX(n),s=t.normalizeY(r);0===i&&this.context.moveTo(a,s),this.context.lineTo(a,s)}return this.context.lineTo(t.normalizeX(e.points[0][0]),t.normalizeY(e.points[0][1])),Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.moveTo=function(t,e){var i=this.data;return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),"line"===this.type?(i.endX+=t-i.startX,i.endY+=e-i.startY,i.startX=t,i.startY=e):"polygon"===this.type?(i.points.forEach(function(n,r){if(r>0){var a=n[0],s=n[1];i.points[r]=[a+(t-i.points[0][0]),s+(e-i.points[0][1])]}}),i.points[0]=[t,e]):(i.offsetX=t,i.offsetY=e),this[this.type](this.base,i),this},function(){var t=["line","rect","circle","ellipse","polygon"];t.forEach(function(t){Martin.prototype[t]=function(e){return new Martin.Element(t,this,e)}})}(),Martin.prototype.desaturate=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){var r=n.r,a=n.g,s=n.b,o=.3*r+.59*a+.11*s;return r=(1-t)*r+t*o,a=(1-t)*a+t*o,s=(1-t)*s+t*o,n.r=r,n.g=a,n.b=s,n})}var n=this;return t/=100,t>1&&(t=1),e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.prototype.saturate=function(t,e){return this.desaturate(-t,e)},Martin.prototype.lighten=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){return n.r+=Math.round(255*t/100),n.g+=Math.round(255*t/100),n.b+=Math.round(255*t/100),n})}var n=this;return e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.prototype.darken=function(t){return this.lighten(-t),this},Martin.prototype.opacity=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){return n.a*=t,n})}var n=this;return e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.mul_shift_table=function(t){var e=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],i=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[e[t],i[t]]},Martin.BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},Martin.prototype.blur=function(t,e){function i(e,i){n.switchToLayer(i);var p,d,y,g,m,x,v,M,w,b,L,E,I,X,Y,C,z,D=r,T=n.context.getImageData(0,0,a,s),k=T.data,P=new Martin.BlurStack,A=P;for(y=1;l>y;y++)A=A.next=new Martin.BlurStack,y===c&&(C=A);for(A.next=P,z=null;D-->0;){for(v=x=0,d=s;--d>-1;){for(M=c*(E=k[x]),w=c*(I=k[x+1]),b=c*(X=k[x+2]),L=c*(Y=k[x+3]),A=P,y=c;--y>-1;)A.r=E,A.g=I,A.b=X,A.a=Y,A=A.next;for(y=1;c>y;y++)g=x+((y>o?o:y)<<2),M+=A.r=k[g],w+=A.g=k[g+1],b+=A.b=k[g+2],L+=A.a=k[g+3],A=A.next;for(z=P,p=0;a>p;p++)k[x++]=M*u>>>f,k[x++]=w*u>>>f,k[x++]=b*u>>>f,k[x++]=L*u>>>f,g=v+((g=p+t+1)<o?g:o)<<2,M-=z.r-(z.r=k[g]),w-=z.g-(z.g=k[g+1]),b-=z.b-(z.b=k[g+2]),L-=z.a-(z.a=k[g+3]),z=z.next;v+=a}for(p=0;a>p;p++){for(x=p<<2,M=c*(E=k[x]),w=c*(I=k[x+1]),b=c*(X=k[x+2]),L=c*(Y=k[x+3]),A=P,y=0;c>y;y++)A.r=E,A.g=I,A.b=X,A.a=Y,A=A.next;for(m=a,y=1;t>=y;y++)x=m+p<<2,M+=A.r=k[x],w+=A.g=k[x+1],b+=A.b=k[x+2],L+=A.a=k[x+3],A=A.next,h>y&&(m+=a);for(x=p,z=P,d=0;s>d;d++)g=x<<2,k[g+3]=Y=L*u>>>f,Y>0?(Y=255/Y,k[g]=(M*u>>>f)*Y,k[g+1]=(w*u>>>f)*Y,k[g+2]=(b*u>>>f)*Y):k[g]=k[g+1]=k[g+2]=0,g=p+((g=d+c)<h?g:h)*a<<2,M-=z.r-(z.r=k[g]),w-=z.g-(z.g=k[g+1]),b-=z.b-(z.b=k[g+2]),L-=z.a-(z.a=k[g+3]),z=z.next,x+=a}}n.putImageData(T)}if(isNaN(t)||1>t)return this;var n=this,r=2,a=this.width(),s=this.height(),o=a-1,h=s-1,c=t+1,l=2*t+1,u=Martin.mul_shift_table(t)[0],f=Martin.mul_shift_table(t)[1];return e?this.layers.forEach(i):i(null,this.currentLayer),this},["width","height"].forEach(function(t){Martin.prototype[t]=function(e,i){if(!e)return this.canvas[t];var n,r,a,s,o;"string"==typeof e&&"%"===e.slice(-1)&&(e=+e.slice(0,-1)*this.canvas[t]/100),r=this.canvas.height,this.container.style[t]=e+"px",a=e/this.canvas[t];for(var h=this.layers.length-1;h>=0;h--)n=this.layers[h].context.getImageData(0,"height"!==t||i?0:this.canvas.height-e,this.canvas.width,this.canvas.height),s=document.createElement("canvas"),o=s.getContext("2d"),s.setAttribute("width",this.canvas.width),s.setAttribute("height",this.canvas.height),o.putImageData(this.layers[h].context.getImageData(0,0,this.canvas.width,this.canvas.height),0,0),this.layers[h].canvas.setAttribute(t,e),i&&this.layers[h].context.scale("width"===t?a:1,"height"===t?a:1),this.layers[h].context.drawImage(s,0,"height"!==t||i?0:e-r);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.write=function(t,e){var i,n,r,a;return"string"==typeof t?(i=t,n=e):(n=t,i=n.text||""),n||(n={}),r=n.size||16,a=r+"px ",a+=n.font?'"'+n.font+'"':"sans-serif",this.context.font=a,this.context.fillStyle=n.color||"#000",this.context.textBaseline="top",this.context.textAlign=n.align||"left",this.context.fillText(i,this.normalizeX(n.offsetX||0),this.normalizeY(n.offsetY||0)),this},Martin.prototype.background=function(t){var e=this.currentLayer,i=0;if("background"!==this.layers[0].type){i=1,this.newLayer({type:"background",fill:t});for(var n=this.layers.pop(),r=this.container.firstChild,a=this.layers.length;a>=0;a--)this.layers[a]=this.layers[a-1]||n;this.switchToLayer(0),this.container.insertBefore(n.canvas,r)}else this.layers[0].fill=t,this.switchToLayer(0);for(var s=Martin.hexToRGB(t),o=s.r,h=s.g,c=s.b,l=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),u=l.data,f=u.length,p=0;f>p;p+=4)u[p]=o,u[p+1]=h,u[p+2]=c,u[p+3]=255;return this.putImageData(l),this.switchToLayer(e+i),this};