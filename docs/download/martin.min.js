!function(){function a(a){return a*(Math.PI/180)}function b(a){if(!a)return!1;"#"===a.slice(0,1)&&(a=a.slice(1));var b,c,d;return 6===a.length?(b=a.slice(0,2),c=a.slice(2,4),d=a.slice(4,6)):3===a.length&&(b=a.slice(0,1)+a.slice(0,1),c=a.slice(1,2)+a.slice(1,2),d=a.slice(2,3)+a.slice(2,3)),{r:parseInt(b,16),g:parseInt(c,16),b:parseInt(d,16)}}window.Martin=function(a,b){if(this.original=document.getElementById(a),!this.original||!a)throw new Error("Must provide a <canvas> or <img> element.");var c=this.handleLoad;this.makeCanvas(c.bind(this),b)},Martin.prototype.makeCanvas=function(a,b){if("IMG"===this.original.tagName){var c=this,d=function(){var d=document.createElement("canvas");return d.width=+c.original.getAttribute("width"),d.height=+c.original.getAttribute("height"),d.getContext("2d").drawImage(c.original,0,0),c.original.parentNode.insertBefore(d,c.original),c.original.parentNode.removeChild(c.original),c.canvas=d,c.context=d.getContext("2d"),a(b)};if(this.original.complete)return d();this.original.onload=d}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),a(b)},Martin.prototype.handleLoad=function(a){var b=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),b.insertBefore(this.container,this.canvas),this.container.appendChild(this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var c=document.createElement("style");return c.innerHTML="[data-martin] *{position:absolute;bottom:0;left:0;}",document.head.appendChild(c),this.layers=[{canvas:this.canvas,context:this.context}],this.currentLayer=0,a(this)},Martin.extend=function(a){for(var b in a)Martin.prototype[b]=a[b]},["width","height"].forEach(function(a){Martin.prototype[a]=function(b,c){var d,e,f,g,h;"string"==typeof b&&"%"===b.slice(-1)&&(b=+b.slice(0,-1)*this.canvas[a]/100),e=this.canvas.height,this.container.style[a]=b+"px",f=b/this.canvas.height;for(var i=this.layers.length-1;i>=0;i--)d=this.layers[i].context.getImageData(0,"height"!==a||c?0:this.canvas.height-b,this.canvas.width,this.canvas.height),g=document.createElement("canvas"),h=g.getContext("2d"),g.setAttribute("width",this.canvas.width),g.setAttribute("height",this.canvas.height),h.putImageData(this.layers[i].context.getImageData(0,0,this.canvas.width,this.canvas.height),0,0),this.layers[i].canvas.setAttribute(a,b),c&&this.layers[i].context.scale("width"===a?f:1,"height"===a?f:1),this.layers[i].context.drawImage(g,0,"height"!==a||c?0:b-e);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.crop=function(){},Martin.prototype.newLayer=function(a,b){var c=document.createElement("canvas"),d={};if(c.width=this.canvas.width,c.height=this.canvas.height,this.container.appendChild(c),this.context=c.getContext("2d"),this.currentLayer=this.layers.length,b&&this.context.putImageData(b,0,0),d.canvas=c,d.context=this.context,"string"==typeof a)d.type=a;else for(var e in a)d[e]=a[e];return this.layers.push(d),this},Martin.prototype.duplicateLayer=function(){return this.newLayer("",this.context.imageData),this},Martin.prototype.switchToLayer=function(a){return this.context=this.layers[a||0].context,this.currentLayer=a||0,this},Martin.prototype.mergeLayers=function(a){function b(d){if(d>0){var e=(a[d],a[d-1]),f=a[d].canvas;return e.context.drawImage(f,0,0),c.container.removeChild(a[d].canvas),a.pop(),b(d-1)}}a||(a=this.layers);var c=this;return b(a.length-1),this},Martin.prototype.write=function(a,b){var c,d;"string"==typeof a?(c=a,d=b):(d=a,c=d.text||""),d||(d={});var e=d.size||16,f=e+"px ";return f+=d.font?'"'+d.font+'"':"sans-serif",this.context.font=f,this.context.fillStyle=d.color||"#000",this.context.textBaseline="top",this.context.textAlign=d.align||"left",this.context.fillText(c,this.normalizeX(d.offsetX||0),d.offsetY?this.normalizeY(d.offsetY)-e:this.canvas.height-e),this},Martin.prototype.normalizeX=function(a){return"string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentX(+a.slice(0,-1)):a},Martin.prototype.normalizeY=function(a){return a="string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentY(+a.slice(0,-1)):a,this.canvas.height-a},Martin.prototype.normalizePercentX=function(a){return a/100*this.canvas.width},Martin.prototype.normalizePercentY=function(a){return a/100*this.canvas.height},Martin.prototype.background=function(a){var c=this.currentLayer,d=0;if("background"!==this.layers[0].type){d=1,this.newLayer({type:"background",fill:a});for(var e=this.layers.pop(),f=this.container.firstChild,g=this.layers.length;g>=0;g--)this.layers[g]=this.layers[g-1]||e;this.switchToLayer(0),this.container.insertBefore(e.canvas,f)}else this.layers[0].fill=a,this.switchToLayer(0);for(var h=b(a),i=h.r,j=h.g,k=h.b,l=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),m=l.data,n=m.length,o=0;n>o;o+=4)m[o]=i,m[o+1]=j,m[o+2]=k,m[o+3]=255;return this.context.putImageData(l,0,0),this.switchToLayer(c+d),this},Martin.prototype.setContext=function(a){var b=this.context;b.save(),b.fillStyle=a.color||"#000",b.fill(),b.globalAlpha=a.alpha||1,b.lineWidth=a.strokeWidth?a.strokeWidth:0,b.lineCap=a.cap?a.cap:"square",b.strokeStyle=a.stroke?a.stroke:"transparent",b.stroke(),b.restore()},Martin.prototype.line=function(a){return this.context.beginPath(),this.context.moveTo(this.normalizeX(a.startX),this.normalizeY(a.startY)),this.context.lineTo(this.normalizeX(a.endX),this.normalizeY(a.endY)),a.strokeWidth||(a.strokeWidth=1),a.stroke=a.color?a.color:"#000",this.setContext(a),this},Martin.prototype.rect=function(a){return this.context.beginPath(),this.context.rect(this.normalizeX(a.offsetX),this.normalizeY(a.offsetY),this.normalizeX(a.width),-this.canvas.height+this.normalizeY(a.height)),this.setContext(a),this.context.closePath(),this},Martin.prototype.circle=function(a){var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);return this.context.beginPath(),this.context.arc(b,c,a.radius,0,2*Math.PI,!1),this.setContext(a),this},Martin.prototype.ellipse=function(a){if(a.radiusX===a.radiusY)return a.radius=a.radiusX,this.circle(a);var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);this.context.beginPath();var d;return a.radiusX>a.radiusY?(d=a.radiusX/a.radiusY,this.context.scale(d,1),this.context.arc(b/d,c,a.radiusX/2,0,2*Math.PI,!1)):(d=a.radiusY/a.radiusX,this.context.scale(1,d),this.context.arc(b,c/d,a.radiusY/2,0,2*Math.PI,!1)),this.setContext(a),this.context.restore(),this},Martin.prototype.polygon=function(a,b){"string"==typeof b&&(b={color:b}),this.context.beginPath();for(var c=0;c<a.length;c++){var d=this.normalizeX(a[c][0]),e=this.normalizeY(a[c][1]);0===c&&this.context.moveTo(d,e),this.context.lineTo(d,e)}return this.context.lineTo(this.normalizeX(a[0][0]),this.normalizeY(a[0][1])),this.setContext(b),this.context.closePath(),this},Martin.prototype.toBW=function(a){function b(a){for(var b=a.getImageData(0,0,c.canvas.width,c.canvas.height),d=b.data,e=d.length,f=0;e>f;f+=4){var g=.3*d[f]+.59*d[f+1]+.11*d[f+2];d[f]=g,d[f+1]=g,d[f+2]=g}a.putImageData(b,0,0)}var c=this;return a?this.layers.forEach(function(a){b(a.context)}):b(this.context),this},Martin.prototype.lighten=function(a,b){function c(b){for(var c=b.getImageData(0,0,d.canvas.width,d.canvas.height),e=c.data,f=e.length,g=0;f>g;g+=4)e[g]+=Math.round(255*a/100),e[g+1]+=Math.round(255*a/100),e[g+2]+=Math.round(255*a/100);b.putImageData(c,0,0)}var d=this;return b?this.layers.forEach(function(a){c(a.context)}):c(this.context),this},Martin.prototype.darken=function(a){return this.lighten(-a),this},Martin.prototype.opacity=function(a,b){function c(b){for(var c=b.getImageData(0,0,d.canvas.width,d.canvas.height),e=c.data,f=e.length,g=0;f>g;g+=4)e[g+3]*=a;b.putImageData(c,0,0)}var d=this;return b?this.layers.forEach(function(a){c(a.context)}):c(this.context),this},Martin.prototype.gradient=function(b){var c=b.angle?b.angle+90:90,d=a(c),e=Math.tan(d);Math.abs(e)>1e4&&(e=!1);var f,g,h,i,j={x:Math.floor(this.canvas.width/2)||b.centerX,y:Math.floor(this.canvas.height/2)||b.centerY},k=Math.round(-e*j.x+j.y),l=function(a,b){var c,d;return 0===e?d=Math.abs(j.y-b):e?(c=(a+e*b-e*k)/(e*e+1),d=(c-a)*(c-a)+(e*c+k-b)*(e*c+k-b),d=Math.sqrt(d)):d=Math.abs(j.x-a),m(a,b).x<0&&(d*=-1),d},m=function(a,b){a-=j.x,b-=j.y;var c={x:b,y:-a},e=Math.cos(-d),f=Math.sin(-d),g={x:c.x*e-c.y*f,y:c.x*e+c.y*f};return g},n=0,o=1,p=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),q=p.data,r=q.length,s=[{x:0,y:0},{x:0,y:this.canvas.height},{x:this.canvas.width,y:0},{x:this.canvas.width,y:this.canvas.height}];s.forEach(function(a){var b=l(a.x,a.y);b>n&&(n=b)}),o=255/n;for(var t=0;r>t;t+=4)f=t/4,g=Math.floor(f%this.canvas.width),h=this.canvas.height-Math.floor(f/this.canvas.width),i=l(g,h),q[t]+=0,q[t+1]+=0,q[t+2]+=0,q[t+3]=.5*(i+n)*o;return this.context.putImageData(p,0,0),this},Martin.prototype.convertToImage=function(){this.mergeLayers();var a=new Image;a.src=this.layers[0].canvas.toDataURL(),this.container.removeChild(this.layers[0].canvas),this.container.appendChild(a)}}(),function(){var a=function(a,b,c){a=a||"Â©",b=b||"#fff",c=c||12;var d=2,e={align:"right",color:b,offsetX:this.canvas.width-d,offsetY:d,size:c};return this.write(a,e),this};Martin.extend({watermark:a})}();