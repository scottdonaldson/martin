window.Martin=function(t){if(!(this instanceof Martin))return new Martin(t);if(this.original=document.getElementById(t),!this.original||!t)throw new Error("Must provide a <canvas> or <img> element.");return this.makeCanvas()},Martin.prototype.makeCanvas=function(){if(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.newLayer(),"IMG"===this.original.tagName){var t=this.canvas,e=(this.context,this.original);t.width=e.naturalWidth,t.height=e.naturalHeight,e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e),new Martin.Element("image",this,{original:e}),e.onload=this.render.bind(this)}else"CANVAS"===this.original.tagName&&(this.canvas=this.original,this.context=this.original.getContext("2d"));return this.render(),this},Martin._version="0.2.2-alpha",Martin.degToRad=function(t){return t*(Math.PI/180)},Martin.radToDeg=function(t){return t*(180/Math.PI)},Martin.hexToRGB=function(t){if(!t)return!1;"#"===t.slice(0,1)&&(t=t.slice(1));var e,n,i;return 6===t.length?(e=t.slice(0,2),n=t.slice(2,4),i=t.slice(4,6)):3===t.length&&(e=t.slice(0,1)+t.slice(0,1),n=t.slice(1,2)+t.slice(1,2),i=t.slice(2,3)+t.slice(2,3)),{r:parseInt(e,16),g:parseInt(n,16),b:parseInt(i,16)}},Martin.extend=function(t){for(var e in t)Martin.prototype[e]=t[e]},Martin.prototype.render=function(){this.layers.forEach(function(t,e){t.clearLayer(),t.elements.forEach(function(t){t.renderElement()}),t.effects.forEach(function(t){t.renderEffect()}),t.renderLayer()})},Martin.prototype.toDataURL=function(){return this.canvas.toDataURL()},Martin.prototype.convertToImage=function(){var t=this.toDataURL(),e=document.createElement("img");e.src=t,this.layers.forEach(function(t,e){this.deleteLayer(e)},this),this.container.appendChild(e)},Martin.prototype.normalizeX=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentX(+t.slice(0,-1)):t},Martin.prototype.normalizeY=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentY(+t.slice(0,-1)):t},Martin.prototype.normalizePercentX=function(t){return t/100*this.canvas.width},Martin.prototype.normalizePercentY=function(t){return t/100*this.canvas.height},Martin.setContext=function(t,e){t.save(),t.fillStyle=e.color||"#000",t.fill(),t.globalAlpha=e.alpha||1,t.lineWidth=e.strokeWidth?e.strokeWidth:0,t.lineCap=e.cap?e.cap:"square",t.strokeStyle=e.stroke?e.stroke:"transparent",t.stroke(),t.restore()},Martin.Layer=function(t,e){if(this.base=t,this.canvas=document.createElement("canvas"),this.canvas.width=t.width(),this.canvas.height=t.height(),this.context=this.canvas.getContext("2d"),"string"==typeof e)this.type=e;else for(var n in e)this[n]=e[n];return this.elements=[],this.effects=[],this},Martin.Layer.prototype.loop=function(t,e){for(var n,i,r,a,s,o,h,c,l,u=this.base.width(),f=this.base.height(),p=this.context.getImageData(0,0,u,f),y=p.data,d=y.length,m=0;d>m;m+=4)n=m/4,i=n%u,r=Math.floor(n/f),a=y[m],s=y[m+1],o=y[m+2],h=y[m+3],c={r:a,g:s,b:o,a:h},l=t.call(this.context,i,r,c),y[m]=l.r,y[m+1]=l.g,y[m+2]=l.b,y[m+3]=l.a;return e!==!1&&this.context.putImageData(p,0,0),this},Martin.Layer.prototype.getImageData=function(){var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);return t},Martin.Layer.prototype.putImageData=function(t){return this.context.putImageData(t,0,0),this},Martin.Layer.prototype.renderLayer=function(){{var t=this.base;this.getImageData()}t.context&&t.context.drawImage(this.canvas,0,0)},Martin.Layer.prototype.clearLayer=function(){this.context.clearRect(0,0,this.base.width(),this.base.height())},Martin.Layer.prototype.addElement=function(t){return this.elements.push(t),t},Martin.prototype.newLayer=function(t,e,n){var i=new Martin.Layer(this,t,e,n);return this.layers?this.layers.push(i):(this.layers=[i],i.canvas=i.base.canvas,i.context=i.base.context),this.currentLayerIndex=this.layers.length,this.currentLayer=i,this.render(),i},Martin.prototype.duplicateLayer=function(){return this.newLayer("",this.context.imageData,this.elements),this},Martin.prototype.deleteLayer=function(t){return t=t||this.currentLayerIndex,this.layers.splice(t,1),this},Martin.prototype.clearLayer=function(t){var e=this.currentLayerIndex;t&&this.switchToLayer(t),this.context.clearRect(0,0,this.width(),this.height()),this.switchToLayer(e)},Martin.prototype.switchToLayer=function(t){return this.context=this.layers[t||0].context,this.currentLayer=this.layers[t||0],this.currentLayerIndex=t||0,this},Martin.Element=function(t,e,n){if(Martin.Element.prototype.hasOwnProperty(t)){var i=e.currentLayer;return this.base=e,this.data=n,this.type=t,this.layer=i,i.addElement(this),this.base.render(),this}throw new Error("Given type is not an allowed element.")},Martin.Element.prototype.renderElement=function(){return this[this.type]()},Martin.Element.prototype.image=function(){var t=this.layer.context,e=this.data;return t.drawImage(e.original,e.x||0,e.y||0),this},Martin.Element.prototype.line=function(){var t=this.base,e=this.layer.context,n=this.data;return e.beginPath(),e.moveTo(t.normalizeX(n.x||0),t.normalizeY(n.y||0)),e.lineTo(t.normalizeX(n.height||t.width()),t.normalizeY(n.width||t.height())),n.strokeWidth||(n.strokeWidth=1),n.stroke=n.color?n.color:"#000",Martin.setContext(e,n),e.closePath(),this},Martin.Element.prototype.rect=function(){var t=this.base,e=this.layer.context,n=this.data;return e.beginPath(),e.rect(t.normalizeX(n.x||0),t.normalizeY(n.y||0),t.normalizeX(n.width),t.normalizeY(n.height)),Martin.setContext(e,n),e.closePath(),this},Martin.Element.prototype.circle=function(){var t=this.base,e=this.layer.context,n=this.data,i=t.normalizeX(n.x||0),r=t.normalizeY(n.y||0);return e.beginPath(),e.arc(i,r,n.radius,0,2*Math.PI,!1),Martin.setContext(e,n),e.closePath(),this},Martin.Element.prototype.ellipse=function(t,e){if(e.radiusX===e.radiusY)return e.radius=e.radiusX,this.circle(t,e);var n,i=t.normalizeX(e.offsetX||0),r=t.normalizeY(e.offsetY||0);return this.context.beginPath(),e.radiusX>e.radiusY?(n=e.radiusX/e.radiusY,this.context.scale(n,1),this.context.arc(i/n,r,e.radiusX/n,0,2*Math.PI,!1),this.context.scale(1/n,1)):(n=e.radiusY/e.radiusX,this.context.scale(1,n),this.context.arc(i,r/n,e.radiusY/n,0,2*Math.PI,!1),this.context.scale(1,1/n)),Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.polygon=function(){var t=this.base,e=this.layer.context,n=this.data;e.beginPath();for(var i=0;i<n.points.length;i++){var r=n.points[i][0],a=n.points[i][1],s=canvas.normalizeX(r),o=canvas.normalizeY(a);0===i&&e.moveTo(s,o),e.lineTo(s,o)}return e.lineTo(t.normalizeX(n.points[0][0]),t.normalizeY(n.points[0][1])),Martin.setContext(e,n),e.closePath(),this},Martin.Element.prototype.text=function(){function t(t,e,n){return(t?t+" ":"")+(e||16)+"px "+(n||"sans-serif")}var e,n,i,r,a=this.base,s=this.layer.context,o=this.data,h={};return n=o.style||"",e=o.size||"",i=o.font||"",r=t(o.style,o.size,o.font),this.fontSize=function(t){return t?(this.data.size=t,t):this.data.size},this.fontStyle=function(t){return t?(this.data.style=t,t):this.data.style},this.font=function(t){return t?(this.data.font=t,t):this.data.style},this.width=function(){return s.measureText(o.text||"").width},Object.defineProperty(h,"theStyle",{get:function(){return n},set:function(e){r=t(e,o.size,o.font)}}),Object.defineProperty(h,"theSize",{get:function(){return e},set:function(e){r=t(o.style,e,o.font)}}),Object.defineProperty(h,"theFont",{get:function(){return i},set:function(e){r=t(o.style,o.size,e)}}),s.font=r,s.fillStyle=o.color||"#000",s.textBaseline="top",s.textAlign=o.align||"left",s.fillText(o.text||"",a.normalizeX(o.x||0),a.normalizeY(o.y||0)),this},Martin.Element.prototype.layerIndex=function(){return this.layer.elements.indexOf(this)},Martin.Element.prototype.remove=function(){return this.layer.elements.splice(this.layerIndex(),1),this.base.render(),this},Martin.Element.prototype.bump=function(t){var e=this.layerIndex();return this.remove(),this.layer.elements.splice(e+t,0,this),this.base.render(),this},Martin.Element.prototype.bumpUp=function(){return this.bump(1)},Martin.Element.prototype.bumpDown=function(){return this.bump(-1)},Martin.Element.prototype.bumpToTop=function(){return this.remove(),this.layer.elements.push(this),this.base.render(),this},Martin.Element.prototype.bumpToBottom=function(){return this.remove(),this.layer.elements.unshift(this),this.base.render(),this},Martin.Element.prototype.moveTo=function(t,e){var n=this.data;return"line"===this.type?(n.endX+=t-n.x,n.endY+=e-n.y):"polygon"===this.type&&(n.points.forEach(function(i,r){if(r>0){var a=i[0],s=i[1];n.points[r]=[a+(t-n.points[0][0]),s+(e-n.points[0][1])]}}),n.points[0]=[t,e]),n.x=t,n.y=e,this[this.type](),this.base.render(),this},function(){var t=["line","rect","circle","ellipse","polygon","text"];t.forEach(function(t){Martin.prototype[t]=function(e){return new Martin.Element(t,this,e)}})}(),Martin.Effect=function(t,e,n){if(Martin.Effect.prototype.hasOwnProperty(t)){var i=e.currentLayer;return this.base=e,this.type=t,this.layer=i,this.amount=n,i.addEffect(this),this.base.render(),this}throw new Error("Given effect is not an allowed effect.")},Martin.Layer.prototype.addEffect=function(t){return this.effects.push(t),t},Martin.Effect.prototype.renderEffect=function(){return this[this.type]()},Martin.Effect.prototype.desaturate=function(t){var e=this.layer,t=t||this.amount;return t/=100,t>1&&(t=1),e.loop(function(e,n,i){var r=i.r,a=i.g,s=i.b,o=.3*r+.59*a+.11*s;return r=(1-t)*r+t*o,a=(1-t)*a+t*o,s=(1-t)*s+t*o,i.r=r,i.g=a,i.b=s,i}),this},Martin.Effect.prototype.saturate=function(t){return this.desaturate(-t)},Martin.Effect.prototype.lighten=function(t){var e=this.layer,t=t||this.amount;return t/=100,t>1&&(t=1),e.loop(function(e,n,i){return i.r+=Math.round(255*t),i.g+=Math.round(255*t),i.b+=Math.round(255*t),i}),this},Martin.Effect.prototype.darken=function(t){return this.lighten(-t)},Martin.Effect.prototype.opacity=function(t){var e=this.layer,t=t||this.amount;return t/=100,t>1&&(t=1),e.loop(function(e,n,i){return i.a*=t,i}),this},Martin._BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},Martin._BlurStack.mul_shift_table=function(t){var e=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],n=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[e[t],n[t]]},Martin.Effect.prototype.blur=function(t){var e=this.layer,t=t||this.amount;if(isNaN(t)||1>t)return this;var n,i,r,a,s,o,h,c,l,u,f,p,y,d,m,g,v,M=2,x=this.base.width(),b=this.base.height(),E=x-1,w=b-1,L=t+1,I=2*t+1,z=Martin._BlurStack.mul_shift_table(t)[0],k=Martin._BlurStack.mul_shift_table(t)[1],P=M,T=e.getImageData(),D=T.data,X=new Martin._BlurStack,Y=X;for(r=1;I>r;r++)Y=Y.next=new Martin._BlurStack,r===L&&(g=Y);for(Y.next=X,v=null;P-->0;){for(h=o=0,i=b;--i>-1;){for(c=L*(p=D[o]),l=L*(y=D[o+1]),u=L*(d=D[o+2]),f=L*(m=D[o+3]),Y=X,r=L;--r>-1;)Y.r=p,Y.g=y,Y.b=d,Y.a=m,Y=Y.next;for(r=1;L>r;r++)a=o+((r>E?E:r)<<2),c+=Y.r=D[a],l+=Y.g=D[a+1],u+=Y.b=D[a+2],f+=Y.a=D[a+3],Y=Y.next;for(v=X,n=0;x>n;n++)D[o++]=c*z>>>k,D[o++]=l*z>>>k,D[o++]=u*z>>>k,D[o++]=f*z>>>k,a=h+((a=n+t+1)<E?a:E)<<2,c-=v.r-(v.r=D[a]),l-=v.g-(v.g=D[a+1]),u-=v.b-(v.b=D[a+2]),f-=v.a-(v.a=D[a+3]),v=v.next;h+=x}for(n=0;x>n;n++){for(o=n<<2,c=L*(p=D[o]),l=L*(y=D[o+1]),u=L*(d=D[o+2]),f=L*(m=D[o+3]),Y=X,r=0;L>r;r++)Y.r=p,Y.g=y,Y.b=d,Y.a=m,Y=Y.next;for(s=x,r=1;t>=r;r++)o=s+n<<2,c+=Y.r=D[o],l+=Y.g=D[o+1],u+=Y.b=D[o+2],f+=Y.a=D[o+3],Y=Y.next,w>r&&(s+=x);for(o=n,v=X,i=0;b>i;i++)a=o<<2,D[a+3]=m=f*z>>>k,m>0?(m=255/m,D[a]=(c*z>>>k)*m,D[a+1]=(l*z>>>k)*m,D[a+2]=(u*z>>>k)*m):D[a]=D[a+1]=D[a+2]=0,a=n+((a=i+L)<w?a:w)*x<<2,c-=v.r-(v.r=D[a]),l-=v.g-(v.g=D[a+1]),u-=v.b-(v.b=D[a+2]),f-=v.a-(v.a=D[a+3]),v=v.next,o+=x}}return e.putImageData(T),this},function(){var t=["desaturate","saturate","lighten","darken","opacity","blur"];t.forEach(function(t){Martin.prototype[t]=function(e){return new Martin.Effect(t,this,e)}})}(),function(){var t=["click","mouseover","mousemove","mouseenter","mouseleave","mousedown","mouseup"];t.forEach(function(t){Martin.prototype[t]=function(e){function n(t){e(t),i.render()}var i=this;return this.canvas.addEventListener(t,n),this}}),Martin.prototype.on=function(e,n){function i(t){n(t),r.render()}var r=this;return t.indexOf(e)>-1&&this.canvas.addEventListener(e,i),this}}(),["width","height"].forEach(function(t){Martin.prototype[t]=function(e,n){if(!e)return this.canvas[t];var i,r,a,s,o;"string"==typeof e&&"%"===e.slice(-1)&&(e=+e.slice(0,-1)*this.canvas[t]/100),r=this.canvas.height,this.container.style[t]=e+"px",a=e/this.canvas[t];for(var h=this.layers.length-1;h>=0;h--)i=this.layers[h].context.getImageData(0,"height"!==t||n?0:this.canvas.height-e,this.canvas.width,this.canvas.height),s=document.createElement("canvas"),o=s.getContext("2d"),s.setAttribute("width",this.canvas.width),s.setAttribute("height",this.canvas.height),o.putImageData(this.layers[h].context.getImageData(0,0,this.canvas.width,this.canvas.height),0,0),this.layers[h].canvas.setAttribute(t,e),n&&this.layers[h].context.scale("width"===t?a:1,"height"===t?a:1),this.layers[h].context.drawImage(s,0,"height"!==t||n?0:e-r);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.background=function(t){var e=this.currentLayer,n=0;if("background"!==this.layers[0].type){n=1;var i=(this.newLayer({type:"background",fill:t}),this.layers.pop()),r=this.container.firstChild;this.layers.unshift(i),this.switchToLayer(0),this.container.insertBefore(i,r)}else this.layers[0].fill=t,this.switchToLayer(0);for(var a=Martin.hexToRGB(t),s=a.r,o=a.g,h=a.b,c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),l=c.data,u=l.length,f=0;u>f;f+=4)l[f]=s,l[f+1]=o,l[f+2]=h,l[f+3]=255;return this.putImageData(c),this.switchToLayer(e+n),this};