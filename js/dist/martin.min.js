window.Martin=function(t,e){if(!(this instanceof Martin))return new Martin(t,e);if(this.original=document.getElementById(t),!this.original||!t)throw new Error("Must provide a <canvas> or <img> element.");var i=this.handleLoad;this.makeCanvas(i.bind(this),e)},Martin._version="0.1.3-beta",Martin.prototype.makeCanvas=function(t,e){if("IMG"===this.original.tagName){var i=this,n=function(){var n=document.createElement("canvas");return n.width=i.original.naturalWidth,n.height=i.original.naturalHeight,n.getContext("2d").drawImage(i.original,0,0),i.original.parentNode.insertBefore(n,i.original),i.original.parentNode.removeChild(i.original),i.canvas=n,i.context=n.getContext("2d"),t(e)};if(this.original.complete)return n();this.original.onload=n}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),t(e)},Martin.prototype.handleLoad=function(t){var e=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),e.insertBefore(this.container,this.canvas),this.container.appendChild(this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var i=document.createElement("style");return i.innerHTML="[data-martin] *{position:absolute;bottom:0;left:0;}",document.head.appendChild(i),this.layers=[{canvas:this.canvas,context:this.context}],this.currentLayer=0,t(this)},Martin.degToRad=function(t){return t*(Math.PI/180)},Martin.radToDeg=function(t){return t*(180/Math.PI)},Martin.hexToRGB=function(t){if(!t)return!1;"#"===t.slice(0,1)&&(t=t.slice(1));var e,i,n;return 6===t.length?(e=t.slice(0,2),i=t.slice(2,4),n=t.slice(4,6)):3===t.length&&(e=t.slice(0,1)+t.slice(0,1),i=t.slice(1,2)+t.slice(1,2),n=t.slice(2,3)+t.slice(2,3)),{r:parseInt(e,16),g:parseInt(i,16),b:parseInt(n,16)}},Martin.extend=function(t){for(var e in t)Martin.prototype[e]=t[e]},Martin.prototype.convertToImage=function(t){if(t)return this.mergeLayers(t);this.mergeLayers();var e=document.createElement("img");e.src=this.layers[0].canvas.toDataURL(),this.container.removeChild(this.layers[0].canvas),this.container.appendChild(e)},Martin.prototype.normalizeX=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentX(+t.slice(0,-1)):t},Martin.prototype.normalizeY=function(t){return t="string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentY(+t.slice(0,-1)):t,this.canvas.height-t},Martin.prototype.normalizePercentX=function(t){return t/100*this.canvas.width},Martin.prototype.normalizePercentY=function(t){return t/100*this.canvas.height},Martin.prototype.setContext=function(t){var e=this.context;e.save(),e.fillStyle=t.color||"#000",e.fill(),e.globalAlpha=t.alpha||1,e.lineWidth=t.strokeWidth?t.strokeWidth:0,e.lineCap=t.cap?t.cap:"square",e.strokeStyle=t.stroke?t.stroke:"transparent",e.stroke(),e.restore()},Martin.prototype.loop=function(t,e){for(var i,n,r,a,s,o,h,c,l,u=this.context.getImageData(0,0,this.width(),this.height()),f=u.data,g=f.length,p=0;g>p;p+=4)i=p/4,n=i%this.width(),r=this.height()-Math.floor(i/this.width()),a=f[p],s=f[p+1],o=f[p+2],h=f[p+3],c={r:a,g:s,b:o,a:h},l=t.call(this,n,r,c),f[p]=l.r,f[p+1]=l.g,f[p+2]=l.b,f[p+3]=l.a;return e!==!1&&this.context.putImageData(u,0,0),this},Martin.prototype.putImageData=function(t){return this.context.putImageData(t,0,0),this},Martin.prototype.newLayer=function(t,e){var i=document.createElement("canvas"),n={};if(i.width=this.canvas.width,i.height=this.canvas.height,this.container.appendChild(i),this.context=i.getContext("2d"),this.currentLayer=this.layers.length,e&&this.context.putImageData(e,0,0),n.canvas=i,n.context=this.context,"string"==typeof t)n.type=t;else for(var r in t)n[r]=t[r];return this.layers.push(n),this},Martin.prototype.duplicateLayer=function(){return this.newLayer("",this.context.imageData),this},Martin.prototype.deleteLayer=function(t){if(!(this.layers.length>1))throw new Error("Can't delete the only layer.");return t=t||this.currentLayer,this.container.removeChild(this.layers[t].canvas),this.layers.splice(t,1),this},Martin.prototype.clearLayer=function(t){var e=this.currentLayer;t&&this.switchToLayer(t),this.context.clearRect(0,0,this.width(),this.height()),this.switchToLayer(e)},Martin.prototype.switchToLayer=function(t){return this.context=this.layers[t||0].context,this.currentLayer=t||0,this},Martin.prototype.mergeLayers=function(t){function e(t){return t>0?(n=s[t-1],r=n.context,i=s[t],a=s[t].canvas,r.drawImage(a,0,0),this.container.removeChild(s[t].canvas),s.pop(),e.call(this,t-1)):void 0}var i,n,r,a,s=this.layers;if(t){var o=0;for(n=document.createElement("canvas"),r=n.getContext("2d"),n.setAttribute("width",this.width()),n.setAttribute("height",this.height());o<s.length;)r.drawImage(s[o].canvas,0,0),o++}else e.call(this,s.length-1);return t?n.toDataURL():this},Martin.prototype.line=function(t){return this.context.beginPath(),this.context.moveTo(this.normalizeX(t.startX),this.normalizeY(t.startY)),this.context.lineTo(this.normalizeX(t.endX),this.normalizeY(t.endY)),t.strokeWidth||(t.strokeWidth=1),t.stroke=t.color?t.color:"#000",this.setContext(t),this},Martin.prototype.rect=function(t){return t.offsetX||(t.offsetX=0),t.offsetY||(t.offsetY=0),this.context.beginPath(),this.context.rect(this.normalizeX(t.offsetX),this.normalizeY(t.offsetY),this.normalizeX(t.width),-this.canvas.height+this.normalizeY(t.height)),this.setContext(t),this.context.closePath(),this},Martin.prototype.circle=function(t){t.offsetX||(t.offsetX=this.width()/2),t.offsetY||(t.offsetY=this.height()/2);var e=this.normalizeX(t.offsetX),i=this.normalizeY(t.offsetY);return this.context.beginPath(),this.context.arc(e,i,t.radius,0,2*Math.PI,!1),this.setContext(t),this},Martin.prototype.ellipse=function(t){if(t.offsetX||(t.offsetX=this.width()/2),t.offsetY||(t.offsetY=this.height()/2),t.radiusX===t.radiusY)return t.radius=t.radiusX,this.circle(t);var e=this.normalizeX(t.offsetX),i=this.normalizeY(t.offsetY);this.context.beginPath();var n;return t.radiusX>t.radiusY?(n=t.radiusX/t.radiusY,this.context.scale(n,1),this.context.arc(e/n,i,t.radiusX/n,0,2*Math.PI,!1)):(n=t.radiusY/t.radiusX,this.context.scale(1,n),this.context.arc(e,i/n,t.radiusY/n,0,2*Math.PI,!1)),this.setContext(t),this.context.restore(),this},Martin.prototype.polygon=function(t,e){"string"==typeof e&&(e={color:e}),this.context.beginPath();for(var i=0;i<t.length;i++){var n=this.normalizeX(t[i][0]),r=this.normalizeY(t[i][1]);0===i&&this.context.moveTo(n,r),this.context.lineTo(n,r)}return this.context.lineTo(this.normalizeX(t[0][0]),this.normalizeY(t[0][1])),this.setContext(e),this.context.closePath(),this},Martin.prototype.desaturate=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){var r=n.r,a=n.g,s=n.b,o=.3*r+.59*a+.11*s;return r=(1-t)*r+t*o,a=(1-t)*a+t*o,s=(1-t)*s+t*o,n.r=r,n.g=a,n.b=s,n})}var n=this;return t/=100,t>1&&(t=1),e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.prototype.saturate=function(t,e){return this.desaturate(-t,e)},Martin.prototype.lighten=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){return n.r+=Math.round(255*t/100),n.g+=Math.round(255*t/100),n.b+=Math.round(255*t/100),n})}var n=this;return e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.prototype.darken=function(t){return this.lighten(-t),this},Martin.prototype.opacity=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){return n.a*=t,n})}var n=this;return e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.mul_shift_table=function(t){var e=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],i=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[e[t],i[t]]},Martin.BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},Martin.prototype.blur=function(t,e){function i(e,i){n.switchToLayer(i);var g,p,d,y,v,m,x,M,w,b,L,X,Y,I,C,z,T,k=r,D=n.context.getImageData(0,0,a,s),P=D.data,E=new Martin.BlurStack,A=E;for(d=1;l>d;d++)A=A.next=new Martin.BlurStack,d===c&&(z=A);for(A.next=E,T=null;k-->0;){for(x=m=0,p=s;--p>-1;){for(M=c*(X=P[m]),w=c*(Y=P[m+1]),b=c*(I=P[m+2]),L=c*(C=P[m+3]),A=E,d=c;--d>-1;)A.r=X,A.g=Y,A.b=I,A.a=C,A=A.next;for(d=1;c>d;d++)y=m+((d>o?o:d)<<2),M+=A.r=P[y],w+=A.g=P[y+1],b+=A.b=P[y+2],L+=A.a=P[y+3],A=A.next;for(T=E,g=0;a>g;g++)P[m++]=M*u>>>f,P[m++]=w*u>>>f,P[m++]=b*u>>>f,P[m++]=L*u>>>f,y=x+((y=g+t+1)<o?y:o)<<2,M-=T.r-(T.r=P[y]),w-=T.g-(T.g=P[y+1]),b-=T.b-(T.b=P[y+2]),L-=T.a-(T.a=P[y+3]),T=T.next;x+=a}for(g=0;a>g;g++){for(m=g<<2,M=c*(X=P[m]),w=c*(Y=P[m+1]),b=c*(I=P[m+2]),L=c*(C=P[m+3]),A=E,d=0;c>d;d++)A.r=X,A.g=Y,A.b=I,A.a=C,A=A.next;for(v=a,d=1;t>=d;d++)m=v+g<<2,M+=A.r=P[m],w+=A.g=P[m+1],b+=A.b=P[m+2],L+=A.a=P[m+3],A=A.next,h>d&&(v+=a);for(m=g,T=E,p=0;s>p;p++)y=m<<2,P[y+3]=C=L*u>>>f,C>0?(C=255/C,P[y]=(M*u>>>f)*C,P[y+1]=(w*u>>>f)*C,P[y+2]=(b*u>>>f)*C):P[y]=P[y+1]=P[y+2]=0,y=g+((y=p+c)<h?y:h)*a<<2,M-=T.r-(T.r=P[y]),w-=T.g-(T.g=P[y+1]),b-=T.b-(T.b=P[y+2]),L-=T.a-(T.a=P[y+3]),T=T.next,m+=a}}n.putImageData(D)}if(isNaN(t)||1>t)return this;var n=this,r=2,a=this.width(),s=this.height(),o=a-1,h=s-1,c=t+1,l=2*t+1,u=Martin.mul_shift_table(t)[0],f=Martin.mul_shift_table(t)[1];return e?this.layers.forEach(i):i(null,this.currentLayer),this},["width","height"].forEach(function(t){Martin.prototype[t]=function(e,i){if(!e)return this.canvas[t];var n,r,a,s,o;"string"==typeof e&&"%"===e.slice(-1)&&(e=+e.slice(0,-1)*this.canvas[t]/100),r=this.canvas.height,this.container.style[t]=e+"px",a=e/this.canvas[t];for(var h=this.layers.length-1;h>=0;h--)n=this.layers[h].context.getImageData(0,"height"!==t||i?0:this.canvas.height-e,this.canvas.width,this.canvas.height),s=document.createElement("canvas"),o=s.getContext("2d"),s.setAttribute("width",this.canvas.width),s.setAttribute("height",this.canvas.height),o.putImageData(this.layers[h].context.getImageData(0,0,this.canvas.width,this.canvas.height),0,0),this.layers[h].canvas.setAttribute(t,e),i&&this.layers[h].context.scale("width"===t?a:1,"height"===t?a:1),this.layers[h].context.drawImage(s,0,"height"!==t||i?0:e-r);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.write=function(t,e){var i,n;"string"==typeof t?(i=t,n=e):(n=t,i=n.text||""),n||(n={});var r=n.size||16,a=r+"px ";return a+=n.font?'"'+n.font+'"':"sans-serif",this.context.font=a,this.context.fillStyle=n.color||"#000",this.context.textBaseline="top",this.context.textAlign=n.align||"left",this.context.fillText(i,this.normalizeX(n.offsetX||0),n.offsetY?this.normalizeY(n.offsetY)-r:this.canvas.height-r),this},Martin.prototype.background=function(t){var e=this.currentLayer,i=0;if("background"!==this.layers[0].type){i=1,this.newLayer({type:"background",fill:t});for(var n=this.layers.pop(),r=this.container.firstChild,a=this.layers.length;a>=0;a--)this.layers[a]=this.layers[a-1]||n;this.switchToLayer(0),this.container.insertBefore(n.canvas,r)}else this.layers[0].fill=t,this.switchToLayer(0);for(var s=Martin.hexToRGB(t),o=s.r,h=s.g,c=s.b,l=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),u=l.data,f=u.length,g=0;f>g;g+=4)u[g]=o,u[g+1]=h,u[g+2]=c,u[g+3]=255;return this.putImageData(l),this.switchToLayer(e+i),this};