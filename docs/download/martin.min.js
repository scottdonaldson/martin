window.Martin=function(t,e){return this instanceof Martin?(this.original=null,"string"==typeof t?this.original=document.getElementById(t):t instanceof HTMLElement&&(this.original=t),this.options=e||{},this.makeCanvas()):new Martin(t,e)},Martin.prototype.makeCanvas=function(){function t(){e.width=n.naturalWidth,e.height=n.naturalHeight,this.width(e.width),this.height(e.height),n.parentNode.insertBefore(e,n),n.parentNode.removeChild(n),new Martin.Element("image",this,{original:n})}if(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.newLayer(),this.original)if("IMG"===this.original.tagName){var e=this.canvas,n=(this.context,this.original);if(n.complete)return t.call(this);n.onload=t.bind(this)}else"CANVAS"===this.original.tagName&&(this.canvas=this.original,this.context=this.original.getContext("2d"));return this.autorender(),this},Martin._version="0.2.5",Martin.degToRad=function(t){return t*(Math.PI/180)},Martin.radToDeg=function(t){return t*(180/Math.PI)},Martin.hexToRGB=function(t){if(!t)return!1;"#"===t.slice(0,1)&&(t=t.slice(1));var e,n,i;return 6===t.length?(e=t.slice(0,2),n=t.slice(2,4),i=t.slice(4,6)):3===t.length&&(e=t.slice(0,1)+t.slice(0,1),n=t.slice(1,2)+t.slice(1,2),i=t.slice(2,3)+t.slice(2,3)),{r:parseInt(e,16),g:parseInt(n,16),b:parseInt(i,16)}},Martin.utils={},Martin.utils.extend=function(t){for(var e in t)Martin.prototype[e]=t[e]},Martin.extend=Martin.utils.extend,Martin.utils.forEach=function(t,e){t&&t.forEach(e)},Martin.prototype.remove=function(){var t=this.canvas,e=t.parentNode;return e&&e.removeChild(this.canvas),this},Martin.prototype.render=function(t){return Martin.utils.forEach(this.layers,function(t,e){t.clear(),Martin.utils.forEach(t.elements,function(t){t.renderElement()}),Martin.utils.forEach(t.effects,function(t){t.renderEffect()}),t.render()}),t?t():this},Martin.prototype.autorender=function(t){return this.options.autorender!==!1?this.render(t):void 0},Martin.prototype.toDataURL=function(){return this.canvas.toDataURL()},Martin.prototype.convertToImage=function(){var t=this.toDataURL(),e=document.createElement("img");e.src=t,this.layers.forEach(function(t,e){this.deleteLayer(e)},this),this.container&&this.container.appendChild(e)},Martin.Layer=function(t,e){if(this.base=t,this.canvas=document.createElement("canvas"),this.canvas.width=t.original?t.original.naturalWidth||t.original.width:t.width(),this.canvas.height=t.original?t.original.naturalHeight||t.original.height:t.height(),this.context=this.canvas.getContext("2d"),this.scale={x:1,y:1},"string"==typeof e)this.type=e;else for(var n in e)this[n]=e[n];return this},Martin.Layer.prototype.normalizeX=function(t){return"string"==typeof t&&"%"===t.slice(-1)&&(t=this.normalizePercentX(+t.slice(0,-1))),t/this.scale.x},Martin.Layer.prototype.normalizeY=function(t){return"string"==typeof t&&"%"===t.slice(-1)&&(t=this.normalizePercentY(+t.slice(0,-1))),t/this.scale.y},Martin.Layer.prototype.normalizePercentX=function(t){return t/100*this.canvas.width},Martin.Layer.prototype.normalizePercentY=function(t){return t/100*this.canvas.height},Martin.Layer.prototype.loop=function(t,e){for(var n,i,r,a,s,o,h,c,l,u=this.base.width(),f=this.base.height(),p=this.getImageData(),y=p.data,d=y.length,m=0;d>m;m+=4)n=m/4,i=n%u,r=Math.floor(n/f),a=y[m],s=y[m+1],o=y[m+2],h=y[m+3],c={r:a,g:s,b:o,a:h},l=t.call(this.context,i,r,c),y[m]=l.r,y[m+1]=l.g,y[m+2]=l.b,y[m+3]=l.a;return e!==!1&&this.putImageData(p),this},Martin.Layer.prototype.setContext=function(t){var e=this.context;e.save(),e.fillStyle=t.color||"#000",e.fill(),e.scale(this.scale.x,this.scale.y),e.globalAlpha=t.alpha||1,e.lineWidth=t.strokeWidth?t.strokeWidth:0,e.lineCap=t.cap?t.cap:"square",e.strokeStyle=t.stroke?t.stroke:"transparent",e.stroke(),e.restore()},Martin.Layer.prototype.getImageData=function(){var t=this.context&&this.canvas.width>0&&this.canvas.height>0?this.context.getImageData(0,0,this.canvas.width,this.canvas.height):null;return t},Martin.Layer.prototype.putImageData=function(t){return this.context.putImageData(t,0,0),this},Martin.Layer.prototype.render=function(){{var t=this.base;this.getImageData()}t.context&&t.context.drawImage(this.canvas,0,0)},Martin.Layer.prototype.clear=function(){return this.context.clearRect(0,0,this.base.width(),this.base.height()),this},Martin.Layer.prototype.remove=function(){return this.base.layers.splice(this.base.layers.indexOf(this),1),this.base.autorender(),this},Martin.Layer.prototype.addElement=function(t){if(!(t instanceof Martin.Element))throw new Error("When adding an element to a layer, it must be created from Martin.Element.");return this.elements?this.elements.push(t):this.elements=[t],this},Martin.prototype.newLayer=function(t){var e=new Martin.Layer(this,t);return this.layers?this.layers.push(e):this.layers=[e],this.currentLayerIndex=this.layers.length,this.currentLayer=e,this.autorender(),e},Martin.prototype.layer=function(t){return this.context=this.layers[t||0].context,this.currentLayer=this.layers[t||0],this.currentLayerIndex=t||0,this.layers[t||0]},Martin.Element=function(t,e,n){if(Martin.Element.prototype.hasOwnProperty(t)){var i=e.currentLayer;return this.base=e,this.data=n,this.type=t,this.layer=i,i.addElement(this),"background"===this.type&&this.bumpToBottom(),this.base.autorender(),this}throw new Error("Given type is not an allowed element.")},Martin.Element.prototype.renderElement=function(){var t=this.layer,e=t.context;return e.scale(t.scale.x,t.scale.y),this[this.type](),e.scale(1/t.scale.x,1/t.scale.y),this},Martin.Element.prototype.image=function(){var t=this.layer,e=t.context,n=this.data;return e.drawImage(n.original,0,0),this},Martin.Element.prototype.background=function(){var t="string"==typeof this.data?this.data:this.data.color,e={};return e.color=t,this.data=e,this.rect()},Martin.Element.prototype.line=function(){var t=this.layer,e=t.context,n=this.data;return e.beginPath(),e.moveTo(t.normalizeX(n.x||0),t.normalizeY(n.y||0)),e.lineTo(t.normalizeX(n.endX),t.normalizeY(n.endY)),n.width=Math.abs(n.endX-n.x),n.height=Math.abs(n.endY-n.y),n.strokeWidth||(n.strokeWidth=1),n.stroke=n.color?n.color:"#000",t.setContext(n),e.closePath(),this},Martin.Element.prototype.rect=function(){var t=this.layer,e=t.context,n=this.data;return e.beginPath(),e.rect(t.normalizeX(n.x||0),t.normalizeY(n.y||0),t.normalizeX(n.width||t.width()),t.normalizeY(n.height||t.height())),t.setContext(n),e.closePath(),this},Martin.Element.prototype.circle=function(){var t=this.layer,e=t.context,n=this.data,i=t.normalizeX(n.x||0),r=t.normalizeY(n.y||0);return e.beginPath(),e.arc(i,r,n.radius,0,2*Math.PI,!1),t.setContext(n),e.closePath(),this},Martin.Element.prototype.ellipse=function(){var t,e=this.layer,n=e.context,i=this.data,r=e.normalizeX(i.x||0),a=e.normalizeY(i.y||0);return i.radiusX===i.radiusY?(i.radius=i.radiusX,this.circle(canvas,i)):(n.beginPath(),i.radiusX>i.radiusY?(t=i.radiusX/i.radiusY,n.scale(t,1),n.arc(r/t,a,i.radiusX/t,0,2*Math.PI,!1),n.scale(1/t,1)):(t=i.radiusY/i.radiusX,n.scale(1,t),n.arc(r,a/t,i.radiusY/t,0,2*Math.PI,!1),n.scale(1,1/t)),e.setContext(i),n.closePath(),this)},Martin.Element.prototype.polygon=function(){var t=this.layer,e=t.context,n=this.data;e.beginPath();for(var i=0;i<n.points.length;i++){var r=n.points[i][0],a=n.points[i][1],s=t.normalizeX(r),o=t.normalizeY(a);0===i&&e.moveTo(s,o),e.lineTo(s,o)}return e.lineTo(t.normalizeX(n.points[0][0]),t.normalizeY(n.points[0][1])),t.setContext(n),e.closePath(),this},Martin.Element.prototype.text=function(){function t(t,e,n){return(t?t+" ":"")+(e||16)+"px "+(n||"sans-serif")}var e,n,i,r,a=this.layer,s=a.context,o=this.data,h={};return n=o.style||"",e=o.size||"",i=o.font||"",r=t(o.style,o.size,o.font),this.fontSize=function(t){return t?(this.data.size=t,t):this.data.size},this.fontStyle=function(t){return t?(this.data.style=t,t):this.data.style},this.font=function(t){return t?(this.data.font=t,t):this.data.style},this.width=function(){return s.measureText(o.text||"").width},Object.defineProperty(h,"theStyle",{get:function(){return n},set:function(e){r=t(e,o.size,o.font)}}),Object.defineProperty(h,"theSize",{get:function(){return e},set:function(e){r=t(o.style,e,o.font)}}),Object.defineProperty(h,"theFont",{get:function(){return i},set:function(e){r=t(o.style,o.size,e)}}),s.font=r,s.fillStyle=o.color||"#000",s.textBaseline="top",s.textAlign=o.align||"left",s.fillText(o.text||"",a.normalizeX(o.x||0),a.normalizeY(o.y||0)),this},Martin.Element.prototype.layerIndex=function(){return this.layer.elements.indexOf(this)},Martin.Element.prototype.remove=function(){return this.layer.elements.splice(this.layerIndex(),1),this.base.autorender(),this},Martin.Element.prototype.bump=function(t){var e=this.layerIndex();return this.remove(),this.layer.elements.splice(e+t,0,this),this.base.autorender(),this},Martin.Element.prototype.bumpUp=function(){return this.bump(1)},Martin.Element.prototype.bumpDown=function(){return this.bump(-1)},Martin.Element.prototype.bumpToTop=function(){return this.remove(),this.layer.elements.push(this),this.base.autorender(),this},Martin.Element.prototype.bumpToBottom=function(){return this.remove(),this.layer.elements.unshift(this),this.base.autorender(),this},Martin.Element.prototype.moveTo=function(t,e){var n=this.data;return t=t||0,e=e||0,"line"===this.type?(n.endX+=t-n.x,n.endY+=e-n.y):"polygon"===this.type&&(n.points.forEach(function(i,r){if(r>0){var a=i[0],s=i[1];n.points[r]=[a+(t-n.points[0][0]),s+(e-n.points[0][1])]}}),n.points[0]=[t,e]),n.x=t,n.y=e,this[this.type](),this.base.autorender(),this},function(){var t=["background","line","rect","circle","ellipse","polygon","text"];t.forEach(function(t){Martin.prototype[t]=function(e){return new Martin.Element(t,this,e)}})}(),Martin.Effect=function(t,e,n){if(Martin.Effect.prototype.hasOwnProperty(t)){var i=e.currentLayer;return this.base=e,this.type=t,this.inverse=!1,this.layer=i,this.amount=n,i.addEffect(this),this.base.autorender(),this}throw new Error("Given effect is not an allowed effect.")},function(){var t=function(t){return this.effects?this.effects.push(t):this.effects=[t],t};Martin.Layer.prototype.addEffect=t}(),Martin.Effect.prototype.renderEffect=function(){return this[this.type]()},Martin.Effect.prototype.invert=function(t){return this.inverse=!0,this[t]()},Martin.Effect.prototype.desaturate=function(){var t=this.layer,e=this.amount;return this.inverse&&(e*=-1),e/=100,e>1&&(e=1),t.loop(function(t,n,i){var r=i.r,a=i.g,s=i.b,o=.3*r+.59*a+.11*s;return r=(1-e)*r+e*o,a=(1-e)*a+e*o,s=(1-e)*s+e*o,i.r=r,i.g=a,i.b=s,i}),this},Martin.Effect.prototype.saturate=function(){return this.invert("desaturate")},Martin.Effect.prototype.lighten=function(){var t=this.layer,e=this.amount;return this.inverse&&(e*=-1),e/=100,e>1&&(e=1),t.loop(function(t,n,i){return i.r+=Math.round(255*e),i.g+=Math.round(255*e),i.b+=Math.round(255*e),i}),this},Martin.Effect.prototype.darken=function(){return this.invert("lighten")},Martin.Effect.prototype.opacity=function(){var t=this.layer,e=this.amount;return e/=100,e>1&&(e=1),t.loop(function(t,n,i){return i.a*=e,i}),this},Martin._BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},Martin._BlurStack.mul_shift_table=function(t){var e=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],n=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[e[t]||e[e.length-1],n[t]||n[n.length-1]]},Martin.Effect.prototype.blur=function(){var t=this.layer,e=this.amount;if(isNaN(e)||1>e)return this;e=Math.round(e);var n,i,r,a,s,o,h,c,l,u,f,p,y,d,m,g,M,v=2,x=this.base.width(),b=this.base.height(),E=x-1,w=b-1,z=e+1,L=2*e+1,I=Martin._BlurStack.mul_shift_table(e)[0],P=Martin._BlurStack.mul_shift_table(e)[1],k=v,X=t.getImageData(),Y=X.data,T=new Martin._BlurStack,C=T;for(r=1;L>r;r++)C=C.next=new Martin._BlurStack,r===z&&(g=C);for(C.next=T,M=null;k-->0;){for(h=o=0,i=b;--i>-1;){for(c=z*(p=Y[o]),l=z*(y=Y[o+1]),u=z*(d=Y[o+2]),f=z*(m=Y[o+3]),C=T,r=z;--r>-1;)C.r=p,C.g=y,C.b=d,C.a=m,C=C.next;for(r=1;z>r;r++)a=o+((r>E?E:r)<<2),c+=C.r=Y[a],l+=C.g=Y[a+1],u+=C.b=Y[a+2],f+=C.a=Y[a+3],C=C.next;for(M=T,n=0;x>n;n++)Y[o++]=c*I>>>P,Y[o++]=l*I>>>P,Y[o++]=u*I>>>P,Y[o++]=f*I>>>P,a=h+((a=n+e+1)<E?a:E)<<2,c-=M.r-(M.r=Y[a]),l-=M.g-(M.g=Y[a+1]),u-=M.b-(M.b=Y[a+2]),f-=M.a-(M.a=Y[a+3]),M=M.next;h+=x}for(n=0;x>n;n++){for(o=n<<2,c=z*(p=Y[o]),l=z*(y=Y[o+1]),u=z*(d=Y[o+2]),f=z*(m=Y[o+3]),C=T,r=0;z>r;r++)C.r=p,C.g=y,C.b=d,C.a=m,C=C.next;for(s=x,r=1;e>=r;r++)o=s+n<<2,c+=C.r=Y[o],l+=C.g=Y[o+1],u+=C.b=Y[o+2],f+=C.a=Y[o+3],C=C.next,w>r&&(s+=x);for(o=n,M=T,i=0;b>i;i++)a=o<<2,Y[a+3]=m=f*I>>>P,m>0?(m=255/m,Y[a]=(c*I>>>P)*m,Y[a+1]=(l*I>>>P)*m,Y[a+2]=(u*I>>>P)*m):Y[a]=Y[a+1]=Y[a+2]=0,a=n+((a=i+z)<w?a:w)*x<<2,c-=M.r-(M.r=Y[a]),l-=M.g-(M.g=Y[a+1]),u-=M.b-(M.b=Y[a+2]),f-=M.a-(M.a=Y[a+3]),M=M.next,o+=x}}return t.putImageData(X),this},Martin.Effect.prototype.increase=function(t){return this.inverse&&(t=-(t||1)),this.amount+=t||1,this.base.autorender(),this},Martin.Effect.prototype.decrease=function(t){return this.increase(-t||-1)},function(){var t=["desaturate","saturate","lighten","darken","opacity","blur"];t.forEach(function(t){Martin.prototype[t]=function(e){return new Martin.Effect(t,this,e)}})}(),function(){var t=["click","mouseover","mousemove","mouseenter","mouseleave","mouseout","mousedown","mouseup"];t.forEach(function(t){Martin.prototype[t]=function(e){function n(t){e(t),this.autorender()}return this.canvas.addEventListener(t,n.bind(this)),this}}),Martin.prototype.on=function(e,n){function i(t){n(t),this.autorender()}return e=e.split(" "),e.forEach(function(e){t.indexOf(e)>-1&&this.canvas.addEventListener(e,i.bind(this))},this),this}}(),["width","height"].forEach(function(t){Martin.prototype[t]=function(e,n){return e?(this.canvas[t]=e,this.layers.forEach(function(i){i[t](e,n)}),this):this.canvas[t]},Martin.Layer.prototype[t]=function(e,n){var i;return e?("string"==typeof e&&"%"===e.slice(-1)&&(e=+e.slice(0,-1)*this.canvas[t]/100),i=n?e/this.canvas[t]:1,n&&("width"===t&&(this.scale.x*=i),"height"===t&&(this.scale.y*=i),this.canvas[t]=e),this.base.autorender(),this):this.canvas[t]}});