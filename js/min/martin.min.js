!function(){function a(a){if(!a)return!1;"#"===a.slice(0,1)&&(a=a.slice(1));var b,c,d;return 6===a.length?(b=a.slice(0,2),c=a.slice(2,4),d=a.slice(4,6)):3===a.length&&(b=a.slice(0,1)+a.slice(0,1),c=a.slice(1,2)+a.slice(1,2),d=a.slice(2,3)+a.slice(2,3)),{r:parseInt(b,16),g:parseInt(c,16),b:parseInt(d,16)}}window.Martin=function(a,b){if(this.original=document.getElementById(a),!this.original||!a)throw new Error("Must provide a <canvas> or <img> element.");var c=this.handleLoad;this.makeCanvas(c.bind(this),b)},Martin.prototype.makeCanvas=function(a,b){if("IMG"===this.original.tagName){var c=this,d=function(){var d=document.createElement("canvas");return d.width=+c.original.getAttribute("width"),d.height=+c.original.getAttribute("height"),d.getContext("2d").drawImage(c.original,0,0),c.original.parentNode.insertBefore(d,c.original),c.original.parentNode.removeChild(c.original),c.canvas=d,c.context=d.getContext("2d"),a(b)};if(this.original.complete)return d();this.original.onload=d}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),a(b)},Martin.prototype.handleLoad=function(a){var b=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),b.insertBefore(this.container,this.canvas),this.container.appendChild(this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var c=document.createElement("style");return c.innerHTML="[data-martin] *{position:absolute;bottom:0;left:0;}",document.head.appendChild(c),this.layers=[{canvas:this.canvas,context:this.context}],a(this)},["width","height"].forEach(function(a){Martin.prototype[a]=function(b){var c=this.context.getImageData(0,"height"===a&&this.canvas[a]-b>0?this.canvas[a]-b:0,this.canvas.width,this.canvas.height);this.container.style[a]=b+"px",this.canvas[a]=b,this.context.putImageData(c,0,"height"===a&&this.canvas[a]-b>0?this.canvas[a]-b:0);for(var d=0;d<this.layers.length;d++)c=this.layers[d].context.getImageData(0,"height"===a?this.canvas[a]-b:0,this.canvas.width,this.canvas.height),this.layers[d].canvas[a]=b,this.layers[d].context.putImageData(c,0,"height"===a&&this.canvas[a]-b>0?this.canvas[a]-b:0);return this.theBackground,this}}),Martin.prototype.crop=function(){},Martin.prototype.newLayer=function(a){var b=document.createElement("canvas");return b.width=this.canvas.width,b.height=this.canvas.height,this.container.appendChild(b),this.context=b.getContext("2d"),this.layers.push({canvas:b,context:b.getContext("2d"),type:a}),this},Martin.prototype.switchToLayer=function(a){return this.context=a?this.layers[a].context:this.layers[0].context,this},Martin.prototype.mergeLayers=function(a){a||(a=this.layers);for(var b=a.length-1;b>0;b--){console.warn("MERGING layer "+b+" down");for(var c=a[b].context.getImageData(0,0,this.canvas.width,this.canvas.height),d=c.data,e=d.length,f=a[b-1].context.getImageData(0,0,this.canvas.width,this.canvas.height),g=f.data,h=0;e>h;h+=4){var i=d[h+3]/255;10>h&&console.log("alpha is",i,"... above is",d[h],"... below was",g[h],"... changin by",(1+i)*(g[h]+d[h])/(1+i)),g[h]+=i*(d[h]-g[h]),g[h+1]+=i*(d[h+1]-g[h+1]),g[h+2]+=i*(d[h+2]-g[h+2]),g[h+3]+=d[h+3]}a[b-1].context.putImageData(f,0,0),this.container.removeChild(this.layers[b].canvas),this.layers.pop()}return this},Martin.prototype.write=function(a){var b=a.size?a.size+"px ":"16px ";b+=a.font?'"'+a.font+'"':"sans-serif",this.context.font=b,this.context.fillStyle=a.color||"#000",this.context.textBaseline="top",this.context.fillText(a.text,a.offsetX||0,this.canvas.height-a.offsetY||0)},Martin.prototype.normalizeX=function(a){return"string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentX(+a.slice(0,-1)):a},Martin.prototype.normalizeY=function(a){return a="string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentY(+a.slice(0,-1)):a,this.canvas.height-a},Martin.prototype.normalizePercentX=function(a){return a/100*this.canvas.width},Martin.prototype.normalizePercentY=function(a){return a/100*this.canvas.height},Martin.prototype.background=function(b){if("background"!==this.layers[0].type){this.newLayer("background");for(var c=this.layers.pop(),d=this.container.firstChild,e=this.layers.length;e>=0;e--)this.layers[e]=this.layers[e-1]||c;this.switchToLayer(0),this.container.insertBefore(c.canvas,d)}else this.switchToLayer(0);for(var f=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),g=f.data,h=g.length,i=a(b),j=i.r,k=i.g,l=i.b,m=0;h>m;m+=4)g[m+3]<=255&&(g[m]=j,g[m+1]=k,g[m+2]=l,g[m+3]=255);return this.context.putImageData(f,0,0),this},Martin.prototype.setContext=function(a){var b=this.context;b.save(),b.fillStyle=a.color||"#000",b.fill(),b.globalAlpha=a.alpha||1,b.lineWidth=a.strokeWidth?a.strokeWidth:0,b.lineCap=a.cap?a.cap:"square",b.strokeStyle=a.stroke?a.stroke:"transparent",b.stroke(),b.restore()},Martin.prototype.line=function(a){return this.context.beginPath(),this.context.moveTo(this.normalizeX(a.startX),this.normalizeY(a.startY)),this.context.lineTo(this.normalizeX(a.endX),this.normalizeY(a.endY)),this.setContext(a),this},Martin.prototype.rect=function(a){return this.context.beginPath(),this.context.rect(this.normalizeX(a.offsetX),this.normalizeY(a.offsetY),this.normalizeX(a.width),-this.canvas.height+this.normalizeY(a.height)),this.setContext(a),this.context.closePath(),this},Martin.prototype.circle=function(a){var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);return this.context.beginPath(),this.context.arc(b,c,a.radius,0,2*Math.PI,!1),this.setContext(a),this},Martin.prototype.ellipse=function(a){if(a.radiusX===a.radiusY)return this.circle(a);var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);this.context.save(),this.context.beginPath();var d;return a.radiusX>a.radiusY?(d=a.radiusX/a.radiusY,this.context.scale(d,1),this.context.arc(b/d,this.canvas.height-c,a.radiusX/2,0,2*Math.PI,!1)):(d=a.radiusY/a.radiusX,this.context.scale(1,d),this.context.arc(b,(this.canvas.height-c)/d,a.radiusY/2,0,2*Math.PI,!1)),this.setContext(a),this.context.restore(),this},Martin.prototype.polygon=function(a,b){this.context.beginPath();for(var c=0;c<a.length;c++){var d=this.normalizeX(a[c][0]),e=this.normalizeY(a[c][1]);0===c&&this.context.moveTo(d,e),this.context.lineTo(d,e)}return this.setContext(b),this.context.closePath(),this},Martin.prototype.toBW=function(){for(var a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=a.data,c=b.length,d=0;c>d;d+=4){var e=.3*b[d]+.59*b[d+1]+.11*b[d+2];b[d]=e,b[d+1]=e,b[d+2]=e}return this.context.putImageData(a,0,0),this},Martin.prototype.lighten=function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,d=c.length,e=0;d>e;e+=4)c[e]+=Math.round(256*a/100),c[e+1]+=Math.round(256*a/100),c[e+2]+=Math.round(256*a/100);return this.context.putImageData(b,0,0),this},Martin.prototype.darken=function(a){return this.lighten(-a),this},Martin.prototype.opacity=function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,d=c.length,e=0;d>e;e+=4)c[e+3]=Math.floor(255*a);return this.context.putImageData(b,0,0),this},Martin.prototype.convertToImage=function(){this.mergeLayers();var a=new Image;a.src=this.layers[0].canvas.toDataURL(),this.container.removeChild(this.layers[0].canvas),this.container.appendChild(a)}}();