window.Martin=function(t){if(!(this instanceof Martin))return new Martin(t);if(this.original=document.getElementById(t),!this.original||!t)throw new Error("Must provide a <canvas> or <img> element.");return this.makeCanvas()},Martin.prototype.makeCanvas=function(){if("IMG"===this.original.tagName){var t=this,e=function(){var e=document.createElement("canvas"),i=e.getContext("2d");return e.width=t.original.naturalWidth,e.height=t.original.naturalHeight,i.drawImage(t.original,0,0),t.original.parentNode.insertBefore(e,t.original),t.original.parentNode.removeChild(t.original),t.canvas=e,t.context=i,t};if(this.original.complete)return e();this.original.onload=e}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),t},Martin.prototype.handleLoad=function(t){var e=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),e.insertBefore(this.container,this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var i=document.createElement("style");i.innerHTML="[data-martin] *{position:absolute;top:0;left:0;}",document.head.appendChild(i),this.container.appendChild(this.canvas),this.newLayer();this.context.getImageData(0,0,this.canvas.width,this.canvas.height);return new Martin.Element("image",this,{original:this.original}),t(this)},Martin._version="0.2.2-alpha",Martin.degToRad=function(t){return t*(Math.PI/180)},Martin.radToDeg=function(t){return t*(180/Math.PI)},Martin.hexToRGB=function(t){if(!t)return!1;"#"===t.slice(0,1)&&(t=t.slice(1));var e,i,n;return 6===t.length?(e=t.slice(0,2),i=t.slice(2,4),n=t.slice(4,6)):3===t.length&&(e=t.slice(0,1)+t.slice(0,1),i=t.slice(1,2)+t.slice(1,2),n=t.slice(2,3)+t.slice(2,3)),{r:parseInt(e,16),g:parseInt(i,16),b:parseInt(n,16)}},Martin.extend=function(t){for(var e in t)Martin.prototype[e]=t[e]},Martin.prototype.render=function(){this.layers.forEach(function(t,e){t.clearLayer(),t.elements.forEach(function(t){t.renderElement()}),t.renderLayer()})},Martin.prototype.toDataURL=function(){return this.canvas.toDataURL()},Martin.prototype.convertToImage=function(){var t=this.toDataURL(),e=document.createElement("img");e.src=t,this.layers.forEach(function(t,e){this.deleteLayer(e)},this),this.container.appendChild(e)},Martin.prototype.normalizeX=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentX(+t.slice(0,-1)):t},Martin.prototype.normalizeY=function(t){return"string"==typeof t&&"%"===t.slice(-1)?this.normalizePercentY(+t.slice(0,-1)):t},Martin.prototype.normalizePercentX=function(t){return t/100*this.canvas.width},Martin.prototype.normalizePercentY=function(t){return t/100*this.canvas.height},Martin.setContext=function(t,e){t.save(),t.fillStyle=e.color||"#000",t.fill(),t.globalAlpha=e.alpha||1,t.lineWidth=e.strokeWidth?e.strokeWidth:0,t.lineCap=e.cap?e.cap:"square",t.strokeStyle=e.stroke?e.stroke:"transparent",t.stroke(),t.restore()},Martin.prototype.loop=function(t,e){for(var i,n,r,a,s,o,h,c,l,u=this.context.getImageData(0,0,this.width(),this.height()),p=u.data,y=p.length,f=0;y>f;f+=4)i=f/4,n=i%this.width(),r=this.height()-Math.floor(i/this.width()),a=p[f],s=p[f+1],o=p[f+2],h=p[f+3],c={r:a,g:s,b:o,a:h},l=t.call(this,n,r,c),p[f]=l.r,p[f+1]=l.g,p[f+2]=l.b,p[f+3]=l.a;return e!==!1&&this.context.putImageData(u,0,0),this},Martin.prototype.putImageData=function(t){return this.context.putImageData(t,0,0),this},Martin.Layer=function(t,e){if(this.base=t,this.canvas=document.createElement("canvas"),this.canvas.width=t.width(),this.canvas.height=t.height(),this.context=this.canvas.getContext("2d"),"string"==typeof e)this.type=e;else for(var i in e)this[i]=e[i];return this.elements=[],this},Martin.Layer.prototype.getImageData=function(){var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);return t},Martin.Layer.prototype.renderLayer=function(){{var t=this.base;this.getImageData()}t.context&&t.context.drawImage(this.canvas,0,0)},Martin.Layer.prototype.clearLayer=function(){this.context.clearRect(0,0,this.base.width(),this.base.height())},Martin.Layer.prototype.addElement=function(t){return this.elements.push(t),t},Martin.prototype.newLayer=function(t,e,i){var n=new Martin.Layer(this,t,e,i);return this.layers?this.layers.push(n):(this.layers=[n],n.canvas=n.base.canvas,n.context=n.base.context),this.currentLayerIndex=this.layers.length,this.currentLayer=n,this.render(),n},Martin.prototype.duplicateLayer=function(){return this.newLayer("",this.context.imageData,this.elements),this},Martin.prototype.deleteLayer=function(t){return t=t||this.currentLayerIndex,this.layers.splice(t,1),this},Martin.prototype.clearLayer=function(t){var e=this.currentLayerIndex;t&&this.switchToLayer(t),this.context.clearRect(0,0,this.width(),this.height()),this.switchToLayer(e)},Martin.prototype.switchToLayer=function(t){return this.context=this.layers[t||0].context,this.currentLayer=this.layers[t||0],this.currentLayerIndex=t||0,this},Martin.Element=function(t,e,i){if(Martin.Element.prototype.hasOwnProperty(t)){var n=e.currentLayer;return this.base=e,this.data=i,this.type=t,this.layer=n,n.addElement(this),this}throw new Error("Given type is not an allowed element.")},Martin.Element.prototype.renderElement=function(){return this[this.type]()},Martin.Element.prototype.image=function(){var t=this.layer.context,e=this.data;return t.drawImage(e.original,e.x||0,e.y||0),this},Martin.Element.prototype.line=function(){var t=this.base,e=this.layer.context,i=this.data;return e.beginPath(),e.moveTo(t.normalizeX(i.x||0),t.normalizeY(i.y||0)),e.lineTo(t.normalizeX(i.height||t.width()),t.normalizeY(i.width||t.height())),i.strokeWidth||(i.strokeWidth=1),i.stroke=i.color?i.color:"#000",Martin.setContext(e,i),e.closePath(),this},Martin.Element.prototype.rect=function(){var t=this.base,e=this.layer.context,i=this.data;return e.beginPath(),e.rect(t.normalizeX(i.x||0),t.normalizeY(i.y||0),t.normalizeX(i.width),t.normalizeY(i.height)),Martin.setContext(e,i),e.closePath(),this},Martin.Element.prototype.circle=function(){var t=this.base,e=this.layer.context,i=this.data,n=t.normalizeX(i.x||0),r=t.normalizeY(i.y||0);return e.beginPath(),e.arc(n,r,i.radius,0,2*Math.PI,!1),Martin.setContext(e,i),e.closePath(),this},Martin.Element.prototype.ellipse=function(t,e){if(e.radiusX===e.radiusY)return e.radius=e.radiusX,this.circle(t,e);var i,n=t.normalizeX(e.offsetX||0),r=t.normalizeY(e.offsetY||0);return this.context.beginPath(),e.radiusX>e.radiusY?(i=e.radiusX/e.radiusY,this.context.scale(i,1),this.context.arc(n/i,r,e.radiusX/i,0,2*Math.PI,!1),this.context.scale(1/i,1)):(i=e.radiusY/e.radiusX,this.context.scale(1,i),this.context.arc(n,r/i,e.radiusY/i,0,2*Math.PI,!1),this.context.scale(1,1/i)),Martin.setContext(this.context,e),this.context.closePath(),this},Martin.Element.prototype.polygon=function(){var t=this.base,e=this.layer.context,i=this.data;e.beginPath();for(var n=0;n<i.points.length;n++){var r=i.points[n][0],a=i.points[n][1],s=canvas.normalizeX(r),o=canvas.normalizeY(a);0===n&&e.moveTo(s,o),e.lineTo(s,o)}return e.lineTo(t.normalizeX(i.points[0][0]),t.normalizeY(i.points[0][1])),Martin.setContext(e,i),e.closePath(),this},Martin.Element.prototype.text=function(){function t(t,e,i){return(t?t+" ":"")+(e||16)+"px "+(i||"sans-serif")}var e,i,n,r,a=this.base,s=this.layer.context,o=this.data,h={};return i=o.style||"",e=o.size||"",n=o.font||"",r=t(o.style,o.size,o.font),this.fontSize=function(t){return t?(this.data.size=t,t):this.data.size},this.fontStyle=function(t){return t?(this.data.style=t,t):this.data.style},this.font=function(t){return t?(this.data.font=t,t):this.data.style},this.width=function(){return s.measureText(o.text||"").width},Object.defineProperty(h,"theStyle",{get:function(){return i},set:function(e){r=t(e,o.size,o.font)}}),Object.defineProperty(h,"theSize",{get:function(){return e},set:function(e){r=t(o.style,e,o.font)}}),Object.defineProperty(h,"theFont",{get:function(){return n},set:function(e){r=t(o.style,o.size,e)}}),s.font=r,s.fillStyle=o.color||"#000",s.textBaseline="top",s.textAlign=o.align||"left",s.fillText(o.text||"",a.normalizeX(o.x||0),a.normalizeY(o.y||0)),this},Martin.Element.prototype.layerIndex=function(){return this.layer.elements.indexOf(this)},Martin.Element.prototype.remove=function(){return this.layer.elements.splice(this.layerIndex(),1),this.base.render(),this},Martin.Element.prototype.bump=function(t){var e=this.layerIndex();return this.remove(),this.layer.elements.splice(e+t,0,this),this.base.render(),this},Martin.Element.prototype.bumpUp=function(){return this.bump(1)},Martin.Element.prototype.bumpDown=function(){return this.bump(-1)},Martin.Element.prototype.bumpToTop=function(){return this.remove(),this.layer.elements.push(this),this.base.render(),this},Martin.Element.prototype.bumpToBottom=function(){return this.remove(),this.layer.elements.unshift(this),this.base.render(),this},Martin.Element.prototype.moveTo=function(t,e){var i=this.data;return"line"===this.type?(i.endX+=t-i.x,i.endY+=e-i.y):"polygon"===this.type&&(i.points.forEach(function(n,r){if(r>0){var a=n[0],s=n[1];i.points[r]=[a+(t-i.points[0][0]),s+(e-i.points[0][1])]}}),i.points[0]=[t,e]),i.x=t,i.y=e,this[this.type](),this.base.render(),this},function(){var t=["line","rect","circle","ellipse","polygon","text"];t.forEach(function(t){Martin.prototype[t]=function(e){return new Martin.Element(t,this,e)}})}(),Martin.prototype.desaturate=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){var r=n.r,a=n.g,s=n.b,o=.3*r+.59*a+.11*s;return r=(1-t)*r+t*o,a=(1-t)*a+t*o,s=(1-t)*s+t*o,n.r=r,n.g=a,n.b=s,n})}var n=this;return t/=100,t>1&&(t=1),e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.prototype.saturate=function(t,e){return this.desaturate(-t,e)},Martin.prototype.lighten=function(t,e){function i(e){n.switchToLayer(e),n.loop(function(e,i,n){return n.r+=Math.round(255*t/100),n.g+=Math.round(255*t/100),n.b+=Math.round(255*t/100),n})}var n=this;return e?this.layers.forEach(function(t,e){i(e)}):i(this.currentLayer),this},Martin.prototype.darken=function(t){return this.lighten(-t),this},Martin.prototype.opacity=function(t,e){function i(e,i){n.switchToLayer(i),n.loop(function(e,i,n){return n.a*=t,n})}var n=this;return e?this.layers.forEach(i):i(this.currentLayer),this},Martin.mul_shift_table=function(t){var e=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],i=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[e[t],i[t]]},Martin.BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},Martin.prototype.blur=function(t,e){function i(e,i){n.switchToLayer(i);var y,f,d,g,m,v,x,M,b,w,L,E,I,z,T,P,k,D=r,X=n.context.getImageData(0,0,a,s),C=X.data,Y=new Martin.BlurStack,B=Y;for(d=1;l>d;d++)B=B.next=new Martin.BlurStack,d===c&&(P=B);for(B.next=Y,k=null;D-->0;){for(x=v=0,f=s;--f>-1;){for(M=c*(E=C[v]),b=c*(I=C[v+1]),w=c*(z=C[v+2]),L=c*(T=C[v+3]),B=Y,d=c;--d>-1;)B.r=E,B.g=I,B.b=z,B.a=T,B=B.next;for(d=1;c>d;d++)g=v+((d>o?o:d)<<2),M+=B.r=C[g],b+=B.g=C[g+1],w+=B.b=C[g+2],L+=B.a=C[g+3],B=B.next;for(k=Y,y=0;a>y;y++)C[v++]=M*u>>>p,C[v++]=b*u>>>p,C[v++]=w*u>>>p,C[v++]=L*u>>>p,g=x+((g=y+t+1)<o?g:o)<<2,M-=k.r-(k.r=C[g]),b-=k.g-(k.g=C[g+1]),w-=k.b-(k.b=C[g+2]),L-=k.a-(k.a=C[g+3]),k=k.next;x+=a}for(y=0;a>y;y++){for(v=y<<2,M=c*(E=C[v]),b=c*(I=C[v+1]),w=c*(z=C[v+2]),L=c*(T=C[v+3]),B=Y,d=0;c>d;d++)B.r=E,B.g=I,B.b=z,B.a=T,B=B.next;for(m=a,d=1;t>=d;d++)v=m+y<<2,M+=B.r=C[v],b+=B.g=C[v+1],w+=B.b=C[v+2],L+=B.a=C[v+3],B=B.next,h>d&&(m+=a);for(v=y,k=Y,f=0;s>f;f++)g=v<<2,C[g+3]=T=L*u>>>p,T>0?(T=255/T,C[g]=(M*u>>>p)*T,C[g+1]=(b*u>>>p)*T,C[g+2]=(w*u>>>p)*T):C[g]=C[g+1]=C[g+2]=0,g=y+((g=f+c)<h?g:h)*a<<2,M-=k.r-(k.r=C[g]),b-=k.g-(k.g=C[g+1]),w-=k.b-(k.b=C[g+2]),L-=k.a-(k.a=C[g+3]),k=k.next,v+=a}}n.putImageData(X)}if(isNaN(t)||1>t)return this;var n=this,r=2,a=this.width(),s=this.height(),o=a-1,h=s-1,c=t+1,l=2*t+1,u=Martin.mul_shift_table(t)[0],p=Martin.mul_shift_table(t)[1];return e?this.layers.forEach(i):i(null,this.currentLayer),this},function(){var t=["click","mouseover","mousemove","mouseenter","mouseleave","mousedown","mouseup"];t.forEach(function(t){Martin.prototype[t]=function(e){function i(t){e(t),n.render()}var n=this;return this.canvas.addEventListener(t,i),this}}),Martin.prototype.on=function(e,i){function n(t){i(t),r.render()}var r=this;return t.indexOf(e)>-1&&this.canvas.addEventListener(e,n),this}}(),["width","height"].forEach(function(t){Martin.prototype[t]=function(e,i){if(!e)return this.canvas[t];var n,r,a,s,o;"string"==typeof e&&"%"===e.slice(-1)&&(e=+e.slice(0,-1)*this.canvas[t]/100),r=this.canvas.height,this.container.style[t]=e+"px",a=e/this.canvas[t];for(var h=this.layers.length-1;h>=0;h--)n=this.layers[h].context.getImageData(0,"height"!==t||i?0:this.canvas.height-e,this.canvas.width,this.canvas.height),s=document.createElement("canvas"),o=s.getContext("2d"),s.setAttribute("width",this.canvas.width),s.setAttribute("height",this.canvas.height),o.putImageData(this.layers[h].context.getImageData(0,0,this.canvas.width,this.canvas.height),0,0),this.layers[h].canvas.setAttribute(t,e),i&&this.layers[h].context.scale("width"===t?a:1,"height"===t?a:1),this.layers[h].context.drawImage(s,0,"height"!==t||i?0:e-r);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.background=function(t){var e=this.currentLayer,i=0;if("background"!==this.layers[0].type){i=1;var n=(this.newLayer({type:"background",fill:t}),this.layers.pop()),r=this.container.firstChild;this.layers.unshift(n),this.switchToLayer(0),this.container.insertBefore(n,r)}else this.layers[0].fill=t,this.switchToLayer(0);for(var a=Martin.hexToRGB(t),s=a.r,o=a.g,h=a.b,c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),l=c.data,u=l.length,p=0;u>p;p+=4)l[p]=s,l[p+1]=o,l[p+2]=h,l[p+3]=255;return this.putImageData(c),this.switchToLayer(e+i),this};