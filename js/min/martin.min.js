!function(){function a(a){return a*(Math.PI/180)}function b(a){if(!a)return!1;"#"===a.slice(0,1)&&(a=a.slice(1));var b,c,d;return 6===a.length?(b=a.slice(0,2),c=a.slice(2,4),d=a.slice(4,6)):3===a.length&&(b=a.slice(0,1)+a.slice(0,1),c=a.slice(1,2)+a.slice(1,2),d=a.slice(2,3)+a.slice(2,3)),{r:parseInt(b,16),g:parseInt(c,16),b:parseInt(d,16)}}window.Martin=function(a,b){if(this.original=document.getElementById(a),!this.original||!a)throw new Error("Must provide a <canvas> or <img> element.");var c=this.handleLoad;this.makeCanvas(c.bind(this),b)},Martin.prototype.makeCanvas=function(a,b){if("IMG"===this.original.tagName){var c=this,d=function(){var d=document.createElement("canvas");return d.width=+c.original.getAttribute("width"),d.height=+c.original.getAttribute("height"),d.getContext("2d").drawImage(c.original,0,0),c.original.parentNode.insertBefore(d,c.original),c.original.parentNode.removeChild(c.original),c.canvas=d,c.context=d.getContext("2d"),a(b)};if(this.original.complete)return d();this.original.onload=d}else if("CANVAS"===this.original.tagName)return this.canvas=this.original,this.context=this.original.getContext("2d"),a(b)},Martin.prototype.handleLoad=function(a){var b=this.canvas.parentNode;this.container=document.createElement("div"),this.container.setAttribute("data-martin",""),b.insertBefore(this.container,this.canvas),this.container.appendChild(this.canvas),this.container.style.position="relative",this.container.style.width=this.canvas.width+"px",this.container.style.height=this.canvas.height+"px";var c=document.createElement("style");return c.innerHTML="[data-martin] *{position:absolute;bottom:0;left:0;}",document.head.appendChild(c),this.layers=[{canvas:this.canvas,context:this.context}],a(this)},["width","height"].forEach(function(a){Martin.prototype[a]=function(b){var c=this.context.getImageData(0,"height"===a&&this.canvas[a]-b>0?this.canvas[a]-b:0,this.canvas.width,this.canvas.height);this.container.style[a]=b+"px",this.canvas[a]=b,this.context.putImageData(c,0,"height"===a&&this.canvas[a]-b>0?this.canvas[a]-b:0);for(var d=0;d<this.layers.length;d++)c=this.layers[d].context.getImageData(0,"height"===a?this.canvas[a]-b:0,this.canvas.width,this.canvas.height),this.layers[d].canvas[a]=b,this.layers[d].context.putImageData(c,0,"height"===a&&this.canvas[a]-b>0?this.canvas[a]-b:0);return"background"===this.layers[0].type&&this.background(this.layers[0].fill),this}}),Martin.prototype.crop=function(){},Martin.prototype.newLayer=function(a){var b=document.createElement("canvas"),c={};if(b.width=this.canvas.width,b.height=this.canvas.height,this.container.appendChild(b),this.context=b.getContext("2d"),c.canvas=b,c.context=b.getContext("2d"),"string"==typeof a)c.type=a;else for(var d in a)c[d]=a[d];return this.layers.push(c),this},Martin.prototype.switchToLayer=function(a){return this.context=a?this.layers[a].context:this.layers[0].context,this},Martin.prototype.mergeLayers=function(a){a||(a=this.layers);for(var b=a.length-1;b>0;b--){for(var c=a[b].context.getImageData(0,0,this.canvas.width,this.canvas.height),d=c.data,e=d.length,f=a[b-1].context.getImageData(0,0,this.canvas.width,this.canvas.height),g=f.data,h=0;e>h;h+=4){var i=d[h+3]/255;g[h]+=i*(d[h]-g[h]),g[h+1]+=i*(d[h+1]-g[h+1]),g[h+2]+=i*(d[h+2]-g[h+2]),g[h+3]+=d[h+3]}a[b-1].context.putImageData(f,0,0),this.container.removeChild(this.layers[b].canvas),this.layers.pop()}return this},Martin.prototype.write=function(a){var b=a.size?a.size+"px ":"16px ";return b+=a.font?'"'+a.font+'"':"sans-serif",this.context.font=b,this.context.fillStyle=a.color||"#000",this.context.textBaseline="top",this.context.fillText(a.text,a.offsetX||0,this.canvas.height-a.offsetY||0),this},Martin.prototype.normalizeX=function(a){return"string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentX(+a.slice(0,-1)):a},Martin.prototype.normalizeY=function(a){return a="string"==typeof a&&"%"===a.slice(-1)?this.normalizePercentY(+a.slice(0,-1)):a,this.canvas.height-a},Martin.prototype.normalizePercentX=function(a){return a/100*this.canvas.width},Martin.prototype.normalizePercentY=function(a){return a/100*this.canvas.height},Martin.prototype.background=function(a){if("background"!==this.layers[0].type){this.newLayer({type:"background",fill:a});for(var c=this.layers.pop(),d=this.container.firstChild,e=this.layers.length;e>=0;e--)this.layers[e]=this.layers[e-1]||c;this.switchToLayer(0),this.container.insertBefore(c.canvas,d)}else this.layers[0].fill=a,this.switchToLayer(0);for(var f=b(a),g=f.r,h=f.g,i=f.b,j=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),k=j.data,l=k.length,m=0;l>m;m+=4)k[m]=g,k[m+1]=h,k[m+2]=i,k[m+3]=255;return this.context.putImageData(j,0,0),this},Martin.prototype.setContext=function(a){var b=this.context;b.save(),b.fillStyle=a.color||"#000",b.fill(),b.globalAlpha=a.alpha||1,b.lineWidth=a.strokeWidth?a.strokeWidth:0,b.lineCap=a.cap?a.cap:"square",b.strokeStyle=a.stroke?a.stroke:"transparent",b.stroke(),b.restore()},Martin.prototype.line=function(a){return this.context.beginPath(),this.context.moveTo(this.normalizeX(a.startX),this.normalizeY(a.startY)),this.context.lineTo(this.normalizeX(a.endX),this.normalizeY(a.endY)),this.setContext(a),this},Martin.prototype.rect=function(a){return this.context.beginPath(),this.context.rect(this.normalizeX(a.offsetX),this.normalizeY(a.offsetY),this.normalizeX(a.width),-this.canvas.height+this.normalizeY(a.height)),this.setContext(a),this.context.closePath(),this},Martin.prototype.circle=function(a){var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);return this.context.beginPath(),this.context.arc(b,c,a.radius,0,2*Math.PI,!1),this.setContext(a),this},Martin.prototype.ellipse=function(a){if(a.radiusX===a.radiusY)return this.circle(a);var b=this.normalizeX(a.offsetX),c=this.normalizeY(a.offsetY);this.context.save(),this.context.beginPath();var d;return a.radiusX>a.radiusY?(d=a.radiusX/a.radiusY,this.context.scale(d,1),this.context.arc(b/d,this.canvas.height-c,a.radiusX/2,0,2*Math.PI,!1)):(d=a.radiusY/a.radiusX,this.context.scale(1,d),this.context.arc(b,(this.canvas.height-c)/d,a.radiusY/2,0,2*Math.PI,!1)),this.setContext(a),this.context.restore(),this},Martin.prototype.polygon=function(a,b){this.context.beginPath();for(var c=0;c<a.length;c++){var d=this.normalizeX(a[c][0]),e=this.normalizeY(a[c][1]);0===c&&this.context.moveTo(d,e),this.context.lineTo(d,e)}return this.setContext(b),this.context.closePath(),this},Martin.prototype.toBW=function(){for(var a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=a.data,c=b.length,d=0;c>d;d+=4){var e=.3*b[d]+.59*b[d+1]+.11*b[d+2];b[d]=e,b[d+1]=e,b[d+2]=e}return this.context.putImageData(a,0,0),this},Martin.prototype.lighten=function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,d=c.length,e=0;d>e;e+=4)c[e]+=Math.round(256*a/100),c[e+1]+=Math.round(256*a/100),c[e+2]+=Math.round(256*a/100);return this.context.putImageData(b,0,0),this},Martin.prototype.darken=function(a){return this.lighten(-a),this},Martin.prototype.opacity=function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,d=c.length,e=0;d>e;e+=4)c[e+3]*=a;return this.context.putImageData(b,0,0),this},Martin.prototype.gradient=function(b){var c=Math.tan(a(b.angle||0));Math.abs(c)>1e4&&(c=!1);var d,e,f,g,h={x:Math.floor(this.canvas.width/2)||b.centerX,y:Math.floor(this.canvas.height/2)||b.centerY},i=Math.round(-c*h.x+h.y),j=function(a,b){var d,e;return c?(d=(a+c*b-c*i)/(c*c+1),e=(d-a)*(d-a)+(c*d+i-b)*(c*d+i-b),e=Math.sqrt(e)):e=Math.abs(h.x-a),e},k=0,l=1,m=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),n=m.data,o=n.length,p=[{x:0,y:0},{x:0,y:this.canvas.height},{x:this.canvas.width,y:0},{x:this.canvas.width,y:this.canvas.height}];p.forEach(function(a){var b=j(a.x,a.y);b>k&&(k=b)}),l=255/k;for(var q=0;o>q;q+=4)d=q/4,e=Math.floor(d%this.canvas.width),f=this.canvas.height-Math.floor(d/this.canvas.width),g=j(e,f),n[q]+=0,n[q+1]+=0,n[q+2]+=0,n[q+3]=g*l;return this.context.putImageData(m,0,0),this},Martin.prototype.fade=function(a){a||(a=0);for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,d=c.length,e=0,f=0,g=this.canvas.height,h=0;d>h;h+=4)e=Math.floor(.25*h/this.canvas.width),f=1-e/g,c[h+3]=255*f;return this.context.putImageData(b,0,0),this},Martin.prototype.convertToImage=function(){this.mergeLayers();var a=new Image;a.src=this.layers[0].canvas.toDataURL(),this.container.removeChild(this.layers[0].canvas),this.container.appendChild(a)}}();