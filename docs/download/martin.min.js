!function(){function t(e,i){return this instanceof t?(this.original=null,"string"==typeof e?this.original=document.getElementById(e):e instanceof HTMLElement&&(this.original=e),this.options=i||{},this.makeCanvas()):new t(e,i)}function e(t,e){t&&t.forEach(e)}function i(){}function n(e,i){function n(n,r){var s=new t.Effect(e,this,n,r);return t.Effect.prototype[e]=function(t){return i.call(s,t||n)},s}t.prototype[e]=function(t){return n.call(this,t,this.currentLayer.effects,this.currentLayer)},t.Layer.prototype[e]=t.Element.prototype[e]=function(t){return n.call(this.base,t,this.effects,this)}}function r(t){this.layer.loop(function(e,i,n){var r=n.r,s=n.g,a=n.b,o=.3*r+.59*s+.11*a;return r=(1-t)*r+t*o,s=(1-t)*s+t*o,a=(1-t)*a+t*o,n.r=r,n.g=s,n.b=a,n})}function s(t){console.log(this),this.layer.loop(function(e,i,n){return n.r+=Math.round(255*t),n.g+=Math.round(255*t),n.b+=Math.round(255*t),n})}t.utils={},t.prototype.makeCanvas=function(){function e(){i.width=n.naturalWidth,i.height=n.naturalHeight,this.width(i.width),this.height(i.height),n.parentNode.insertBefore(i,n),n.parentNode.removeChild(n),new t.Element("image",this,{original:n})}if(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.newLayer(),this.original)if("IMG"===this.original.tagName){var i=this.canvas,n=(this.context,this.original);if(n.complete)return e.call(this);n.onload=e.bind(this)}else"CANVAS"===this.original.tagName&&(this.canvas=this.original,this.context=this.original.getContext("2d"));return this.autorender(),this},t._version="0.3.0",t.degToRad=function(t){return t*(Math.PI/180)},t.radToDeg=function(t){return t*(180/Math.PI)},t.hexToRGB=function(t){if(!t)return!1;"#"===t.slice(0,1)&&(t=t.slice(1));var e,i,n;return 6===t.length?(e=t.slice(0,2),i=t.slice(2,4),n=t.slice(4,6)):3===t.length&&(e=t.slice(0,1)+t.slice(0,1),i=t.slice(1,2)+t.slice(1,2),n=t.slice(2,3)+t.slice(2,3)),{r:parseInt(e,16),g:parseInt(i,16),b:parseInt(n,16)}},t.utils.forEach=e,t.utils.noop=i;var a,o={extend:function(e){for(var i in e){if(t.prototype.hasOwnProperty(i))throw new Error("Careful! This method already exists on the Martin prototype. Try a different name after checking the docs: http://martinjs.org");t.prototype[i]=e[i]}},remove:function(){var t=this.canvas,e=t.parentNode;return e&&e.removeChild(this.canvas),this},render:function(e){return t.utils.forEach(this.layers,function(e,i){e.clear(),t.utils.forEach(e.elements,function(t){t.renderElement()}),t.utils.forEach(e.effects,function(t){t.renderEffect()}),e.render()}),e?e():this},autorender:function(t){return this.options.autorender!==!1?this.render(t):t?t():null},toDataURL:function(){return this.canvas.toDataURL()},convertToImage:function(){var t=this.toDataURL(),e=document.createElement("img");e.src=t,this.layers.forEach(function(t,e){this.deleteLayer(e)},this),this.container&&this.container.appendChild(e)}};for(a in o)t.prototype[a]=o[a];t.Object=function(){};var h,c;h={stackIndex:function(){return this.stack.indexOf(this)},remove:function(){return this.stack.splice(this.stackIndex(),1),this.base.autorender(),this},bump:function(t){var e=this.stackIndex();return this.remove(),this.stack.splice(e+t,0,this),this.base.autorender(),this},bumpUp:function(){return this.bump(1)},bumpDown:function(){return this.bump(-1)},bumpToTop:function(){return this.remove(),this.stack.push(this),this.base.autorender(),this},bumpToBottom:function(){return this.remove(),this.stack.unshift(this),this.base.autorender(),this}};for(c in h)t.Object.prototype[c]=h[c];t.Layer=function(t,e){if(this.base=t,this.canvas=document.createElement("canvas"),this.canvas.width=t.original?t.original.naturalWidth||t.original.width:t.width(),this.canvas.height=t.original?t.original.naturalHeight||t.original.height:t.height(),this.context=this.canvas.getContext("2d"),this.scale={x:1,y:1},this.elements=[],this.effects=[],this.base.layers||(this.base.layers=[]),this.stack=this.base.layers,this.stack.push(this),"string"==typeof e)this.type=e;else for(var i in e)this[i]=e[i];return this},t.Layer.prototype=Object.create(t.Object.prototype),t.Layer.prototype.normalizeX=function(t){return"string"==typeof t&&"%"===t.slice(-1)&&(t=this.normalizePercentX(+t.slice(0,-1))),t/this.scale.x},t.Layer.prototype.normalizeY=function(t){return"string"==typeof t&&"%"===t.slice(-1)&&(t=this.normalizePercentY(+t.slice(0,-1))),t/this.scale.y},t.Layer.prototype.normalizePercentX=function(t){return t/100*this.canvas.width},t.Layer.prototype.normalizePercentY=function(t){return t/100*this.canvas.height},t.Layer.prototype.loop=function(t,e){var i,n,r,s,a,o,h,c,u,l,f,p,y=this.base.width(),d=this.base.height();if(i=this.getImageData()){n=i.data,r=n.length;for(var g=0;r>g;g+=4)s=g/4,a=s%y,o=Math.floor(s/d),h=n[g],c=n[g+1],u=n[g+2],l=n[g+3],f={r:h,g:c,b:u,a:l},p=t.call(this.context,a,o,f),n[g]=p.r,n[g+1]=p.g,n[g+2]=p.b,n[g+3]=p.a;e!==!1&&this.putImageData(i)}return this},t.Layer.prototype.setContext=function(t){var e=this.context;e.save(),e.fillStyle=t.color||"#000",e.fill(),e.scale(this.scale.x,this.scale.y),e.globalAlpha=t.alpha||1,e.lineWidth=t.strokeWidth?t.strokeWidth:0,e.lineCap=t.cap?t.cap:"square",e.strokeStyle=t.stroke?t.stroke:"transparent",e.stroke(),e.restore()},t.Layer.prototype.getImageData=function(){var t=this.context&&this.canvas.width>0&&this.canvas.height>0?this.context.getImageData(0,0,this.canvas.width,this.canvas.height):null;return t},t.Layer.prototype.putImageData=function(t){return this.context.putImageData(t,0,0),this},t.Layer.prototype.render=function(){{var t=this.base;this.getImageData()}t.context&&t.context.drawImage(this.canvas,0,0)},t.Layer.prototype.clear=function(){return this.context.clearRect(0,0,this.base.width(),this.base.height()),this},t.Layer.prototype.remove=function(){return this.base.layers.splice(this.base.layers.indexOf(this),1),this.base.autorender(),this},t.prototype.newLayer=function(e){var i=new t.Layer(this,e);return this.currentLayerIndex=this.layers.length-1,this.currentLayer=i,this.autorender(),i},t.prototype.layer=function(t){return this.context=this.layers[t||0].context,this.currentLayer=this.layers[t||0],this.currentLayerIndex=t||0,this.layers[t||0]},t.Element=function(e,i,n){if(t.Element.prototype.hasOwnProperty(e)){var r=i.currentLayer;return this.base=i,this.data=n,this.type=e,this.layer=r,this.effects=[],this.stack=this.layer.elements,this.stack.push(this),"background"===this.type&&this.bumpToBottom(),this.base.autorender(),this}throw new Error("Given type is not an allowed element.")},t.Element.prototype=Object.create(t.Object.prototype),t.Element.prototype.renderElement=function(){var t=this.layer,e=t.context;return e.scale(t.scale.x,t.scale.y),this[this.type](),e.scale(1/t.scale.x,1/t.scale.y),this},t.Element.prototype.image=function(){var t=this.layer,e=t.context,i=this.data;return e.drawImage(i.original,0,0),this},t.Element.prototype.background=function(){var t="string"==typeof this.data?this.data:this.data.color,e={};return e.color=t,this.data=e,this.rect()},t.Element.prototype.line=function(){var t=this.layer,e=t.context,i=this.data;return e.beginPath(),e.moveTo(t.normalizeX(i.x||0),t.normalizeY(i.y||0)),e.lineTo(t.normalizeX(i.endX),t.normalizeY(i.endY)),i.width=Math.abs(i.endX-i.x),i.height=Math.abs(i.endY-i.y),i.strokeWidth||(i.strokeWidth=1),i.stroke=i.color?i.color:"#000",t.setContext(i),e.closePath(),this},t.Element.prototype.rect=function(){var t=this.layer,e=t.context,i=this.data;return e.beginPath(),e.rect(t.normalizeX(i.x||0),t.normalizeY(i.y||0),t.normalizeX(i.width||t.width()),t.normalizeY(i.height||t.height())),t.setContext(i),e.closePath(),this},t.Element.prototype.circle=function(){var t=this.layer,e=t.context,i=this.data,n=t.normalizeX(i.x||0),r=t.normalizeY(i.y||0);return e.beginPath(),e.arc(n,r,i.radius,0,2*Math.PI,!1),t.setContext(i),e.closePath(),this},t.Element.prototype.ellipse=function(){var t,e=this.layer,i=e.context,n=this.data,r=e.normalizeX(n.x||0),s=e.normalizeY(n.y||0);return n.radiusX===n.radiusY?(n.radius=n.radiusX,this.circle(canvas,n)):(i.beginPath(),n.radiusX>n.radiusY?(t=n.radiusX/n.radiusY,i.scale(t,1),i.arc(r/t,s,n.radiusX/t,0,2*Math.PI,!1),i.scale(1/t,1)):(t=n.radiusY/n.radiusX,i.scale(1,t),i.arc(r,s/t,n.radiusY/t,0,2*Math.PI,!1),i.scale(1,1/t)),e.setContext(n),i.closePath(),this)},t.Element.prototype.polygon=function(){var t=this.layer,e=t.context,i=this.data;e.beginPath();for(var n=0;n<i.points.length;n++){var r=i.points[n][0],s=i.points[n][1],a=t.normalizeX(r),o=t.normalizeY(s);0===n&&e.moveTo(a,o),e.lineTo(a,o)}return e.lineTo(t.normalizeX(i.points[0][0]),t.normalizeY(i.points[0][1])),t.setContext(i),e.closePath(),this},t.Element.prototype.text=function(){function t(t,e,i){return(t?t+" ":"")+(e||16)+"px "+(i||"sans-serif")}var e,i,n,r,s=this.layer,a=s.context,o=this.data,h={};return i=o.style||"",e=o.size||"",n=o.font||"",r=t(o.style,o.size,o.font),this.fontSize=function(t){return t?(this.data.size=t,t):this.data.size},this.fontStyle=function(t){return t?(this.data.style=t,t):this.data.style},this.font=function(t){return t?(this.data.font=t,t):this.data.style},this.width=function(){return a.measureText(o.text||"").width},Object.defineProperty(h,"theStyle",{get:function(){return i},set:function(e){r=t(e,o.size,o.font)}}),Object.defineProperty(h,"theSize",{get:function(){return e},set:function(e){r=t(o.style,e,o.font)}}),Object.defineProperty(h,"theFont",{get:function(){return n},set:function(e){r=t(o.style,o.size,e)}}),a.font=r,a.fillStyle=o.color||"#000",a.textBaseline="top",a.textAlign=o.align||"left",a.fillText(o.text||"",s.normalizeX(o.x||0),s.normalizeY(o.y||0)),this},t.Element.prototype.update=function(t,e){var i,n;if(e)i=t,n=e,this.data[i]=n;else for(i in t)n=t[i],this.data[i]=n;this.base.autorender()},t.Element.prototype.moveTo=function(t,e){var i=this.data;return t=t||0,e=e||0,"line"===this.type?(i.endX+=t-i.x,i.endY+=e-i.y):"polygon"===this.type&&(i.points.forEach(function(n,r){if(r>0){var s=n[0],a=n[1];i.points[r]=[s+(t-i.points[0][0]),a+(e-i.points[0][1])]}}),i.points[0]=[t,e]),i.x=t,i.y=e,this[this.type](),this.base.autorender(),this},function(){var e=["background","line","rect","circle","ellipse","polygon","text"];e.forEach(function(e){t.prototype[e]=function(i){return new t.Element(e,this,i)}})}(),t.Effect=function(t,e,i,n,r){var s=e.currentLayer;return this.base=e,this.type=t,this.inverse=!1,this.layer=s,this.data=i,this.context=r,this.stack=n,this.stack.push(this),this.base.autorender(),this},t.Effect.prototype=Object.create(t.Object.prototype),t.Effect.prototype.renderEffect=function(){return this&&"function"==typeof this[this.type]?this[this.type](this.data):null},n("desaturate",function(t){return t/=100,r.call(this,t),this}),n("saturate",function(t){return t=-t/100,r.call(this,t),this}),n("lighten",function(t){return t/=100,s.call(this,t),this}),n("darken",function(t){return t=-t/100,s.call(this,t),this}),n("opacity",function(t){return t/=100,this.layer.loop(function(e,i,n){return n.a*=t,n}),this}),t.utils.BlurStack=function(){this.r=this.g=this.b=this.a=0,this.next=null},t.utils.BlurStack.mul_shift_table=function(t){var e=[1,171,205,293,57,373,79,137,241,27,391,357,41,19,283,265,497,469,443,421,25,191,365,349,335,161,155,149,9,278,269,261,505,245,475,231,449,437,213,415,405,395,193,377,369,361,353,345,169,331,325,319,313,307,301,37,145,285,281,69,271,267,263,259,509,501,493,243,479,118,465,459,113,446,55,435,429,423,209,413,51,403,199,393,97,3,379,375,371,367,363,359,355,351,347,43,85,337,333,165,327,323,5,317,157,311,77,305,303,75,297,294,73,289,287,71,141,279,277,275,68,135,67,133,33,262,260,129,511,507,503,499,495,491,61,121,481,477,237,235,467,232,115,457,227,451,7,445,221,439,218,433,215,427,425,211,419,417,207,411,409,203,202,401,399,396,197,49,389,387,385,383,95,189,47,187,93,185,23,183,91,181,45,179,89,177,11,175,87,173,345,343,341,339,337,21,167,83,331,329,327,163,81,323,321,319,159,79,315,313,39,155,309,307,153,305,303,151,75,299,149,37,295,147,73,291,145,289,287,143,285,71,141,281,35,279,139,69,275,137,273,17,271,135,269,267,133,265,33,263,131,261,130,259,129,257,1],i=[0,9,10,11,9,12,10,11,12,9,13,13,10,9,13,13,14,14,14,14,10,13,14,14,14,13,13,13,9,14,14,14,15,14,15,14,15,15,14,15,15,15,14,15,15,15,15,15,14,15,15,15,15,15,15,12,14,15,15,13,15,15,15,15,16,16,16,15,16,14,16,16,14,16,13,16,16,16,15,16,13,16,15,16,14,9,16,16,16,16,16,16,16,16,16,13,14,16,16,15,16,16,10,16,15,16,14,16,16,14,16,16,14,16,16,14,15,16,16,16,14,15,14,15,13,16,16,15,17,17,17,17,17,17,14,15,17,17,16,16,17,16,15,17,16,17,11,17,16,17,16,17,16,17,17,16,17,17,16,17,17,16,16,17,17,17,16,14,17,17,17,17,15,16,14,16,15,16,13,16,15,16,14,16,15,16,12,16,15,16,17,17,17,17,17,13,16,15,17,17,17,16,15,17,17,17,16,15,17,17,14,16,17,17,16,17,17,16,15,17,16,14,17,16,15,17,16,17,17,16,17,15,16,17,14,17,16,15,17,16,17,13,17,16,17,17,16,17,14,17,16,17,16,17,16,17,9];return[e[t]||e[e.length-1],i[t]||i[i.length-1]]},n("blur",function(e){if(isNaN(e)||1>e)return this;e=Math.round(e);var i,n,r,s,a,o,h,c,u,l,f,p,y,d,g,m,v,b=2,x=this.base.width(),E=this.base.height(),w=x-1,k=E-1,L=e+1,z=2*e+1,I=t.utils.BlurStack.mul_shift_table(e)[0],P=t.utils.BlurStack.mul_shift_table(e)[1],X=b,Y=this.layer.getImageData(),T=Y.data,C=new t.utils.BlurStack,M=C;for(r=1;z>r;r++)M=M.next=new t.utils.BlurStack,r===L&&(m=M);for(M.next=C,v=null;X-->0;){for(h=o=0,n=E;--n>-1;){for(c=L*(p=T[o]),u=L*(y=T[o+1]),l=L*(d=T[o+2]),f=L*(g=T[o+3]),M=C,r=L;--r>-1;)M.r=p,M.g=y,M.b=d,M.a=g,M=M.next;for(r=1;L>r;r++)s=o+((r>w?w:r)<<2),c+=M.r=T[s],u+=M.g=T[s+1],l+=M.b=T[s+2],f+=M.a=T[s+3],M=M.next;for(v=C,i=0;x>i;i++)T[o++]=c*I>>>P,T[o++]=u*I>>>P,T[o++]=l*I>>>P,T[o++]=f*I>>>P,s=h+((s=i+e+1)<w?s:w)<<2,c-=v.r-(v.r=T[s]),u-=v.g-(v.g=T[s+1]),l-=v.b-(v.b=T[s+2]),f-=v.a-(v.a=T[s+3]),v=v.next;h+=x}for(i=0;x>i;i++){for(o=i<<2,c=L*(p=T[o]),u=L*(y=T[o+1]),l=L*(d=T[o+2]),f=L*(g=T[o+3]),M=C,r=0;L>r;r++)M.r=p,M.g=y,M.b=d,M.a=g,M=M.next;for(a=x,r=1;e>=r;r++)o=a+i<<2,c+=M.r=T[o],u+=M.g=T[o+1],l+=M.b=T[o+2],f+=M.a=T[o+3],M=M.next,k>r&&(a+=x);for(o=i,v=C,n=0;E>n;n++)s=o<<2,T[s+3]=g=f*I>>>P,g>0?(g=255/g,T[s]=(c*I>>>P)*g,T[s+1]=(u*I>>>P)*g,T[s+2]=(l*I>>>P)*g):T[s]=T[s+1]=T[s+2]=0,s=i+((s=n+L)<k?s:k)*x<<2,c-=v.r-(v.r=T[s]),u-=v.g-(v.g=T[s+1]),l-=v.b-(v.b=T[s+2]),f-=v.a-(v.a=T[s+3]),v=v.next,o+=x}}return this.layer.putImageData(Y),this}),t.Effect.prototype.increase=function(t){return"number"==typeof this.data&&(this.data+=t||1,this.base.autorender()),this},t.Effect.prototype.decrease=function(t){return this.increase(-t||-1)},t.registerEffect=n,function(){var e=["click","mouseover","mousemove","mouseenter","mouseleave","mouseout","mousedown","mouseup"];e.forEach(function(e){t.prototype[e]=function(t){function i(e){t(e),this.autorender()}return this.canvas.addEventListener(e,i.bind(this)),this}}),t.prototype.on=function(t,i){function n(t){i(t),this.autorender()}return t=t.split(" "),t.forEach(function(t){e.indexOf(t)>-1&&this.canvas.addEventListener(t,n.bind(this))},this),this}}(),["width","height"].forEach(function(e){t.prototype[e]=function(t,i){return t?(this.canvas[e]=t,this.layers.forEach(function(n){n[e](t,i)}),this):this.canvas[e]},t.Layer.prototype[e]=function(t,i){var n;return t?("string"==typeof t&&"%"===t.slice(-1)&&(t=+t.slice(0,-1)*this.canvas[e]/100),n=i?t/this.canvas[e]:1,i&&("width"===e&&(this.scale.x*=n),"height"===e&&(this.scale.y*=n),this.canvas[e]=t),this.base.autorender(),this):this.canvas[e]}}),this.Martin=t}();